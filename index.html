<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OncoGu√≠a Pro v11.1 - OncoTech La Paz BCS</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --oncotech-red: #DC143C;
            --oncotech-dark: #1a1a1a;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --background: #ffffff;
            --surface: #f8f9fa;
            --border: #dee2e6;
        }

        [data-theme="dark"] {
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --background: #121212;
            --surface: #1e1e1e;
            --border: #495057;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            font-family: 'Calibri', Arial, sans-serif;
            transition: all 0.3s ease;
        }

        .oncotech-header {
            background: linear-gradient(135deg, var(--oncotech-red) 0%, #b91c3c 100%);
            box-shadow: 0 2px 10px rgba(220, 20, 60, 0.3);
        }

        .tab-button {
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .tab-button.active {
            background: var(--oncotech-red);
            color: white;
            transform: translateY(-2px);
        }

        .tab-button:not(.active) {
            background: var(--surface);
            color: var(--text-secondary);
        }

        .tab-button:not(.active):hover {
            background: #e9ecef;
            color: var(--text-primary);
        }

        .input-field {
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            background: var(--background);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            border-color: var(--oncotech-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .preview-area {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            min-height: 600px;
            padding: 20px;
            overflow-y: auto;
        }

        .medication-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .lab-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .custom-exam {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
        }

        [data-theme="dark"] .custom-exam {
            background: #1a237e;
            border-color: #3f51b5;
        }

        .scheme-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scheme-card:hover {
            border-color: var(--oncotech-red);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .scheme-card.selected {
            border-color: var(--oncotech-red);
            background: rgba(220, 20, 60, 0.05);
        }

         {
            .no-print {
                display: none !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
        }

        .calculation-result {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }

        [data-theme="dark"] .calculation-result {
            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
            border-color: #66bb6a;
        }
    </style>
</head>
<body>
    <!-- Header OncoTech -->
    <div class="oncotech-header text-white p-4">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center space-x-4">
                <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" 
                     alt="OncoTech Logo" class="h-12 w-auto">
                <div>
                    <h1 class="text-2xl font-bold">OncoGu√≠a Pro v11.1</h1>
                    <p class="text-sm opacity-90">Sistema Avanzado de Indicaciones Oncol√≥gicas</p>
                </div>
            </div>
            <div class="text-right text-sm">
                <p><strong>OncoTech - Centro de Oncolog√≠a</strong></p>
                <p>Normal Urbana 1367, Colonia Perla, La Paz, BCS</p>
                <p>Tel: (612) 129.71.71 | L-V 9:00-21:00</p>
                <p class="text-xs opacity-75">Solo con previa cita ‚Ä¢ No urgencias</p>
            </div>
            <div class="no-print">
                <select id="themeSelector" class="bg-white text-gray-800 rounded px-3 py-1">
                    <option value="light">Modo Claro</option>
                    <option value="dark">Modo Oscuro</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Datos del Paciente Horizontal -->
    <div class="bg-white shadow-sm border-b p-4">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-lg font-semibold mb-3 text-gray-800">üìã Datos del Paciente</h2>
            <div class="grid grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                    <input type="text" id="patientName" class="input-field w-full" placeholder="Nombre del paciente">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Edad (a√±os) *</label>
                    <input type="number" id="patientAge" class="input-field w-full" placeholder="65" min="0" max="120">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sexo *</label>
                    <select id="patientGender" class="input-field w-full">
                        <option value="">Seleccionar...</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso (kg) *</label>
                    <input type="number" id="patientWeight" class="input-field w-full" placeholder="70" min="20" max="300" step="0.1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estatura (cm) *</label>
                    <input type="number" id="patientHeight" class="input-field w-full" placeholder="170" min="100" max="250">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Creatinina (mg/dL)</label>
                    <input type="number" id="patientCreatinine" class="input-field w-full" placeholder="1.0" min="0.1" max="15" step="0.1">
                </div>
            </div>
            
            <!-- C√°lculos Autom√°ticos -->
            <div class="mt-4">
                <div class="grid grid-cols-4 gap-4" id="calculationResults">
                    <div class="calculation-result">
                        <span class="text-sm font-medium">SC: </span>
                        <span id="bsaResult">-- m¬≤</span>
                    </div>
                    <div class="calculation-result">
                        <span class="text-sm font-medium">IMC: </span>
                        <span id="bmiResult">-- kg/m¬≤</span>
                    </div>
                    <div class="calculation-result">
                        <span class="text-sm font-medium">ClCr (CG): </span>
                        <span id="clcrResult">-- mL/min</span>
                    </div>
                    <div class="calculation-result">
                        <span class="text-sm font-medium">Diagn√≥stico: </span>
                        <input type="text" id="diagnosis" class="input-field" placeholder="Ej: Ca mama T2N1M0 HER2+">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pesta√±as de Funciones -->
    <div class="bg-gray-50 border-b">
        <div class="max-w-7xl mx-auto">
            <div class="flex space-x-1 p-2">
                <button class="tab-button active px-6 py-3 font-medium" data-tab="indications">
                    <i class="fas fa-file-medical mr-2"></i>Indicaciones
                </button>
                <button class="tab-button px-6 py-3 font-medium" data-tab="guide">
                    <i class="fas fa-user-md mr-2"></i>Gu√≠a
                </button>
                <button class="tab-button px-6 py-3 font-medium" data-tab="requests">
                    <i class="fas fa-flask mr-2"></i>Solicitudes
                </button>
                <button class="tab-button px-6 py-3 font-medium" data-tab="prescriptions">
                    <i class="fas fa-prescription mr-2"></i>Recetas
                </button>
            </div>
        </div>
    </div>

    <!-- √Årea de Contenido -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-12 gap-6">
            <!-- Panel Izquierdo - Formularios -->
            <div class="col-span-5 no-print">
                <!-- Indicaciones M√©dicas -->
                <div id="indications-panel" class="tab-content">
                    <h3 class="text-xl font-bold mb-4">üìã Indicaciones M√©dicas</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                        <select id="documentType" class="input-field w-full">
                            <option value="medical">Indicaciones M√©dicas</option>
                            <option value="patient">Gu√≠a para Paciente</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Esquema de Tratamiento</label>
                        <select id="treatmentScheme" class="input-field w-full">
                            <option value="">Seleccionar esquema...</option>
                            <optgroup label="Esquemas de Colorrectal">
                                <option value="folfiri">FOLFIRI</option>
                                <option value="folfiri-cetuximab">FOLFIRI + Cetuximab</option>
                                <option value="folfiri-bevacizumab">FOLFIRI + Bevacizumab</option>
                                <option value="folfox">FOLFOX</option>
                                <option value="capox">CAPOX</option>
                                <option value="capox-bevacizumab">CAPOX + Bevacizumab</option>
                                <option value="folfirinox">FOLFIRINOX</option>
                                <option value="gramont">Esquema de Gramont</option>
                            </optgroup>
                            <optgroup label="Esquemas de Mama">
                                <option value="ac">AC (Doxorrubicina + Ciclofosfamida)</option>
                                <option value="ac-t">AC-T (AC seguido de Paclitaxel)</option>
                                <option value="tch">TCH (Docetaxel + Carboplatino + Trastuzumab)</option>
                                <option value="paclitaxel-weekly">Paclitaxel semanal</option>
                                <option value="paclitaxel-triweekly">Paclitaxel trisemanal</option>
                                <option value="docetaxel">Docetaxel</option>
                            </optgroup>
                            <optgroup label="Anti-HER2">
                                <option value="trastuzumab-iv">Trastuzumab IV</option>
                                <option value="trastuzumab-sc">Trastuzumab SC</option>
                                <option value="pertuzumab">Pertuzumab</option>
                                <option value="t-dm1">T-DM1 (Kadcyla)</option>
                                <option value="t-dxd">T-DXd (Enhertu)</option>
                                <option value="phesgo">Phesgo (Pertuzumab + Trastuzumab SC)</option>
                            </optgroup>
                            <optgroup label="Esquemas de Test√≠culo">
                                <option value="bep">BEP</option>
                                <option value="ep">EP</option>
                            </optgroup>
                            <optgroup label="Esquemas de G√°strico">
                                <option value="flot">FLOT</option>
                            </optgroup>
                            <optgroup label="Esquemas de Ovario/Ginecol√≥gico">
                                <option value="carboplatin-paclitaxel">Carboplatino + Paclitaxel</option>
                                <option value="gemcitabine-carboplatin">Gemcitabina + Carboplatino</option>
                            </optgroup>
                            <optgroup label="Monodrogas">
                                <option value="cisplatin">Cisplatino</option>
                                <option value="carboplatin">Carboplatino</option>
                                <option value="gemcitabine">Gemcitabina</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Ciclos</label>
                        <input type="number" id="numberOfCycles" class="input-field w-full" placeholder="4" min="1" max="12">
                    </div>

                    <div class="mb-4" id="aucSection" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">AUC objetivo (Carboplatino)</label>
                        <select id="targetAUC" class="input-field w-full">
                            <option value="5">AUC 5</option>
                            <option value="6" selected>AUC 6</option>
                            <option value="7">AUC 7</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas Adicionales</label>
                        <textarea id="additionalNotes" class="input-field w-full h-24" placeholder="Notas espec√≠ficas del caso..."></textarea>
                    </div>

                    <button onclick="generateDocument()" class="btn-primary w-full">
                        <i class="fas fa-file-medical mr-2"></i>Generar Documento
                    </button>
                </div>

                <!-- Gu√≠as para Pacientes -->
                <div id="guide-panel" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4">üë®‚Äç‚öïÔ∏è Gu√≠a para Paciente</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Gu√≠a</label>
                        <select id="guideType" class="input-field w-full">
                            <option value="chemo">Gu√≠a de Quimioterapia</option>
                            <option value="side-effects">Manejo de Efectos Secundarios</option>
                            <option value="nutrition">Recomendaciones Nutricionales</option>
                            <option value="care">Cuidados Generales</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Esquema de Tratamiento</label>
                        <select id="guideScheme" class="input-field w-full">
                            <option value="">Seleccionar esquema...</option>
                            <!-- Same options as treatment scheme -->
                        </select>
                    </div>

                    <button onclick="generateGuide()" class="btn-primary w-full">
                        <i class="fas fa-user-md mr-2"></i>Generar Gu√≠a
                    </button>
                </div>

                <!-- Solicitudes (Laboratorio e Imagen) -->
                <div id="requests-panel" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4">üß™ Solicitudes</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Solicitud</label>
                        <select id="requestType" class="input-field w-full" onchange="toggleRequestType()">
                            <option value="laboratory">Laboratorio</option>
                            <option value="imaging">Estudios de Imagen</option>
                        </select>
                    </div>

                    <!-- Laboratorio -->
                    <div id="laboratory-section">
                        <h4 class="font-semibold mb-3">Paneles de Laboratorio</h4>
                        
                        <div class="space-y-3 mb-4">
                            <div class="lab-panel">
                                <h5 class="font-medium mb-2">Panel B√°sico</h5>
                                <div class="grid grid-cols-1 gap-2">
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="hemograma"> Hemograma completo</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="quimica"> Qu√≠mica sangu√≠nea</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="hepaticas"> Pruebas hep√°ticas</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="renales"> Funci√≥n renal</label>
                                </div>
                            </div>

                            <div class="lab-panel">
                                <h5 class="font-medium mb-2">Pre-Quimioterapia</h5>
                                <div class="grid grid-cols-1 gap-2">
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="coagulacion"> Tiempos de coagulaci√≥n</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="electrolitos"> Electrolitos</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="magnesio"> Magnesio</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="fosforo"> F√≥sforo</label>
                                </div>
                            </div>

                            <div class="lab-panel">
                                <h5 class="font-medium mb-2">Seguimiento</h5>
                                <div class="grid grid-cols-1 gap-2">
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="cea"> CEA</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="ca199"> CA 19-9</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="ca125"> CA 125</label>
                                    <label class="flex items-center"><input type="checkbox" class="mr-2" value="ca153"> CA 15-3</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="font-medium mb-2">Ex√°menes Personalizados</h5>
                            <div id="customExams">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="customExamInput" class="input-field flex-1" placeholder="Agregar examen personalizado...">
                                    <button onclick="addCustomExam()" class="btn-secondary">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Imagen -->
                    <div id="imaging-section" class="hidden">
                        <h4 class="font-semibold mb-3">Estudios de Imagen</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Estudio</label>
                            <select id="imagingType" class="input-field w-full">
                                <option value="tc">Tomograf√≠a Computarizada</option>
                                <option value="rm">Resonancia Magn√©tica</option>
                                <option value="us">Ultrasonido</option>
                                <option value="rx">Radiograf√≠a</option>
                                <option value="pet">PET-CT</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Regi√≥n Anat√≥mica</label>
                            <select id="anatomicRegion" class="input-field w-full">
                                <option value="torax">T√≥rax</option>
                                <option value="abdomen">Abdomen</option>
                                <option value="pelvis">Pelvis</option>
                                <option value="tap">T√≥rax, Abdomen y Pelvis</option>
                                <option value="craneo">Cr√°neo</option>
                                <option value="cuello">Cuello</option>
                                <option value="extremidades">Extremidades</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="withContrast" class="mr-2">
                                Con contraste
                            </label>
                        </div>
                    </div>

                    <button onclick="generateRequest()" class="btn-primary w-full">
                        <i class="fas fa-flask mr-2"></i>Generar Solicitud
                    </button>
                </div>

                <!-- Recetas -->
                <div id="prescriptions-panel" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4">üíä Recetas M√©dicas</h3>
                    
                    <div id="medications">
                        <!-- Medicamentos se agregan din√°micamente -->
                    </div>

                    <button onclick="addMedication()" class="btn-secondary w-full mb-4">
                        <i class="fas fa-plus mr-2"></i>Agregar Medicamento
                    </button>

                    <button onclick="generatePrescription()" class="btn-primary w-full">
                        <i class="fas fa-prescription mr-2"></i>Generar Receta
                    </button>
                </div>
            </div>

            <!-- Panel Derecho - Preview -->
            <div class="col-span-7">
                <div class="mb-4 no-print">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">üëÅÔ∏è Previsualizaci√≥n del Documento</h3>
                        <div class="space-x-2">
                            <button onclick="exportPDF()" class="btn-primary">
                                <i class="fas fa-file-pdf mr-2"></i>Generar PDF
                            </button>
                            <button onclick="exportJSON()" class="btn-secondary">
                                <i class="fas fa-download mr-2"></i>Exportar JSON
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="preview-area" id="documentPreview">
                    <div class="text-center text-gray-500 mt-20">
                        <i class="fas fa-file-alt text-6xl mb-4 opacity-30"></i>
                        <p class="text-lg">Complete los datos del paciente y seleccione un esquema para ver la previsualizaci√≥n</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Esquemas de quimioterapia completos
        const chemotherapySchemes = {
            folfiri: {
                name: "FOLFIRI",
                category: "Colorrectal",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Irinotec√°n", dose: "180", unit: "mg/m¬≤", day: "1", infusion: "90 min", solution: "Dextrosa 5%" },
                    { name: "Leucovorina", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "2400", unit: "mg/m¬≤", day: "1-2", infusion: "46 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Requiere bomba de infusi√≥n para 5-FU continuo"
            },
            "folfiri-cetuximab": {
                name: "FOLFIRI + Cetuximab",
                category: "Colorrectal RAS wild",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Cetuximab", dose: "500", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "Irinotec√°n", dose: "180", unit: "mg/m¬≤", day: "1", infusion: "90 min", solution: "Dextrosa 5%" },
                    { name: "Leucovorina", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "2400", unit: "mg/m¬≤", day: "1-2", infusion: "46 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 8mg IV", "Ondansetr√≥n 8mg IV"],
                specialNotes: "Monitoreo estrecho primera infusi√≥n de Cetuximab"
            },
            "folfiri-bevacizumab": {
                name: "FOLFIRI + Bevacizumab",
                category: "Colorrectal metast√°sico",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Bevacizumab", dose: "5", unit: "mg/kg", day: "1", infusion: "90 min", solution: "SF 0.9%" },
                    { name: "Irinotec√°n", dose: "180", unit: "mg/m¬≤", day: "1", infusion: "90 min", solution: "Dextrosa 5%" },
                    { name: "Leucovorina", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "2400", unit: "mg/m¬≤", day: "1-2", infusion: "46 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Vigilar hipertensi√≥n y proteinuria"
            },
            folfox: {
                name: "FOLFOX",
                category: "Colorrectal",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Oxaliplatino", dose: "85", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "Dextrosa 5%" },
                    { name: "Leucovorina", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "2400", unit: "mg/m¬≤", day: "1-2", infusion: "46 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Evitar fr√≠o durante infusi√≥n de oxaliplatino"
            },
            capox: {
                name: "CAPOX",
                category: "Colorrectal",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Oxaliplatino", dose: "130", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "Dextrosa 5%" },
                    { name: "Capecitabina", dose: "1000", unit: "mg/m¬≤", day: "1-14", infusion: "VO BID", solution: "Oral" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Descanso d√≠as 15-21. Vigilar s√≠ndrome mano-pie"
            },
            "capox-bevacizumab": {
                name: "CAPOX + Bevacizumab",
                category: "Colorrectal",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Bevacizumab", dose: "7.5", unit: "mg/kg", day: "1", infusion: "90 min", solution: "SF 0.9%" },
                    { name: "Oxaliplatino", dose: "130", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "Dextrosa 5%" },
                    { name: "Capecitabina", dose: "1000", unit: "mg/m¬≤", day: "1-14", infusion: "VO BID", solution: "Oral" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Vigilar hipertensi√≥n, proteinuria y s√≠ndrome mano-pie"
            },
            folfirinox: {
                name: "FOLFIRINOX",
                category: "P√°ncreas",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Oxaliplatino", dose: "85", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "Dextrosa 5%" },
                    { name: "Irinotec√°n", dose: "180", unit: "mg/m¬≤", day: "1", infusion: "90 min", solution: "Dextrosa 5%" },
                    { name: "Leucovorina", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "2400", unit: "mg/m¬≤", day: "1-2", infusion: "46 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV", "Atropina 0.25mg SC"],
                specialNotes: "Esquema muy emetog√©nico. Requiere profilaxis antiem√©tica intensa"
            },
            gramont: {
                name: "Esquema de Gramont",
                category: "Colorrectal",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "Leucovorina", dose: "200", unit: "mg/m¬≤", day: "1-2", infusion: "120 min", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "400", unit: "mg/m¬≤", day: "1-2", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "5-Fluorouracilo", dose: "600", unit: "mg/m¬≤", day: "1-2", infusion: "22 horas", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV"],
                specialNotes: "Esquema cl√°sico de 5-FU modulado"
            },
            ac: {
                name: "AC",
                category: "Mama",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Doxorrubicina", dose: "60", unit: "mg/m¬≤", day: "1", infusion: "15 min", solution: "SF 0.9%" },
                    { name: "Ciclofosfamida", dose: "600", unit: "mg/m¬≤", day: "1", infusion: "30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV"],
                specialNotes: "Monitoreo cardiaco (FEVI). Dosis acumulativa m√°xima doxorrubicina 450-500 mg/m¬≤"
            },
            "ac-t": {
                name: "AC-T",
                category: "Mama",
                schedule: "AC x4 ‚Üí Paclitaxel x12",
                drugs: [
                    { name: "Doxorrubicina", dose: "60", unit: "mg/m¬≤", day: "1", infusion: "15 min", solution: "SF 0.9%" },
                    { name: "Ciclofosfamida", dose: "600", unit: "mg/m¬≤", day: "1", infusion: "30 min", solution: "SF 0.9%" },
                    { name: "Paclitaxel", dose: "80", unit: "mg/m¬≤", day: "1", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 20mg IV", "Ranitidina 50mg IV"],
                specialNotes: "Secuencial: 4 ciclos AC c/21d seguidos de 12 ciclos Paclitaxel semanal"
            },
            tch: {
                name: "TCH",
                category: "Mama HER2+",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Docetaxel", dose: "75", unit: "mg/m¬≤", day: "1", infusion: "60 min", solution: "SF 0.9%" },
                    { name: "Carboplatino", dose: "AUC 6", unit: "", day: "1", infusion: "60 min", solution: "Dextrosa 5%" },
                    { name: "Trastuzumab", dose: "8‚Üí6", unit: "mg/kg", day: "1", infusion: "90‚Üí30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 20mg IV", "Ranitidina 50mg IV"],
                specialNotes: "Monitoreo cardiaco. Trastuzumab: carga 8mg/kg, mantenimiento 6mg/kg"
            },
            "paclitaxel-weekly": {
                name: "Paclitaxel semanal",
                category: "Mama/Ovario",
                schedule: "Semanal x3, descanso 1 semana",
                drugs: [
                    { name: "Paclitaxel", dose: "80", unit: "mg/m¬≤", day: "1,8,15", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 20mg IV", "Ranitidina 50mg IV"],
                specialNotes: "D√≠as 1, 8, 15 cada 28 d√≠as. Vigilar neuropat√≠a perif√©rica"
            },
            "paclitaxel-triweekly": {
                name: "Paclitaxel trisemanal",
                category: "Mama/Ovario",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Paclitaxel", dose: "175", unit: "mg/m¬≤", day: "1", infusion: "180 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 20mg IV", "Ranitidina 50mg IV"],
                specialNotes: "Infusi√≥n prolongada. Vigilar reacciones de hipersensibilidad"
            },
            docetaxel: {
                name: "Docetaxel",
                category: "Mama/Pr√≥stata/Pulm√≥n",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Docetaxel", dose: "100", unit: "mg/m¬≤", day: "1", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Dexametasona 8mg VO 12h, 3h y 1h antes"],
                specialNotes: "Premedicaci√≥n obligatoria. Vigilar retenci√≥n h√≠drica y neuropat√≠a"
            },
            "trastuzumab-iv": {
                name: "Trastuzumab IV",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Trastuzumab", dose: "8‚Üí6", unit: "mg/kg", day: "1", infusion: "90‚Üí30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Paracetamol 1g VO", "Difenhidramina 25mg VO"],
                specialNotes: "Carga 8mg/kg (90 min), mantenimiento 6mg/kg (30 min). Monitoreo cardiaco"
            },
            "trastuzumab-sc": {
                name: "Trastuzumab SC",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Trastuzumab SC", dose: "600", unit: "mg", day: "1", infusion: "2-5 min", solution: "Subcut√°neo" }
                ],
                premedication: ["Paracetamol 1g VO"],
                specialNotes: "Administraci√≥n subcut√°nea en muslo. Rotar sitios de aplicaci√≥n"
            },
            pertuzumab: {
                name: "Pertuzumab",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Pertuzumab", dose: "840‚Üí420", unit: "mg", day: "1", infusion: "60‚Üí30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 8mg IV"],
                specialNotes: "Carga 840mg (60 min), mantenimiento 420mg (30 min)"
            },
            "t-dm1": {
                name: "T-DM1 (Kadcyla)",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "T-DM1", dose: "3.6", unit: "mg/kg", day: "1", infusion: "90‚Üí30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Paracetamol 1g VO"],
                specialNotes: "Primera infusi√≥n 90 min, siguientes 30 min si tolera bien"
            },
            "t-dxd": {
                name: "T-DXd (Enhertu)",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "T-DXd", dose: "5.4", unit: "mg/kg", day: "1", infusion: "90 min", solution: "Dextrosa 5%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 8mg IV", "Ondansetr√≥n 8mg IV"],
                specialNotes: "Vigilar neumonitis intersticial. Premedicaci√≥n antiem√©tica"
            },
            phesgo: {
                name: "Phesgo",
                category: "Anti-HER2",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Phesgo", dose: "1200/600‚Üí600/600", unit: "mg", day: "1", infusion: "5-8 min", solution: "Subcut√°neo" }
                ],
                premedication: ["Paracetamol 1g VO", "Difenhidramina 25mg VO"],
                specialNotes: "Carga: Pertuzumab 1200mg + Trastuzumab 600mg. Mantenimiento: 600mg + 600mg"
            },
            bep: {
                name: "BEP",
                category: "Tumor germinal testicular",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Bleomicina", dose: "30", unit: "U", day: "2,9,16", infusion: "Bolo", solution: "SF 0.9%" },
                    { name: "Etop√≥sido", dose: "100", unit: "mg/m¬≤", day: "1-5", infusion: "60 min", solution: "SF 0.9%" },
                    { name: "Cisplatino", dose: "20", unit: "mg/m¬≤", day: "1-5", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV"],
                specialNotes: "Hidrataci√≥n pre y post cisplatino. Audiometr√≠a basal. Funci√≥n pulmonar (bleomicina)"
            },
            ep: {
                name: "EP",
                category: "Tumor germinal testicular",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Etop√≥sido", dose: "100", unit: "mg/m¬≤", day: "1-5", infusion: "60 min", solution: "SF 0.9%" },
                    { name: "Cisplatino", dose: "20", unit: "mg/m¬≤", day: "1-5", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV"],
                specialNotes: "Hidrataci√≥n pre y post cisplatino. Monitoreo renal y auditivo"
            },
            flot: {
                name: "FLOT",
                category: "G√°strico/Uni√≥n gastroesof√°gica",
                schedule: "Cada 14 d√≠as",
                drugs: [
                    { name: "5-Fluorouracilo", dose: "2600", unit: "mg/m¬≤", day: "1", infusion: "24 horas", solution: "SF 0.9%" },
                    { name: "Leucovorina", dose: "200", unit: "mg/m¬≤", day: "1", infusion: "60 min", solution: "SF 0.9%" },
                    { name: "Oxaliplatino", dose: "85", unit: "mg/m¬≤", day: "1", infusion: "120 min", solution: "Dextrosa 5%" },
                    { name: "Docetaxel", dose: "50", unit: "mg/m¬≤", day: "1", infusion: "60 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV"],
                specialNotes: "Perioperatorio: 4 ciclos pre y 4 post cirug√≠a"
            },
            "carboplatin-paclitaxel": {
                name: "Carboplatino + Paclitaxel",
                category: "Ovario",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Paclitaxel", dose: "175", unit: "mg/m¬≤", day: "1", infusion: "180 min", solution: "SF 0.9%" },
                    { name: "Carboplatino", dose: "AUC 6", unit: "", day: "1", infusion: "60 min", solution: "Dextrosa 5%" }
                ],
                premedication: ["Difenhidramina 50mg IV", "Dexametasona 20mg IV", "Ranitidina 50mg IV"],
                specialNotes: "Est√°ndar primera l√≠nea ovario. Vigilar neuropat√≠a y trombocitopenia"
            },
            "gemcitabine-carboplatin": {
                name: "Gemcitabina + Carboplatino",
                category: "Ovario/Vesical",
                schedule: "Cada 21 d√≠as",
                drugs: [
                    { name: "Gemcitabina", dose: "1000", unit: "mg/m¬≤", day: "1,8", infusion: "30 min", solution: "SF 0.9%" },
                    { name: "Carboplatino", dose: "AUC 4", unit: "", day: "1", infusion: "60 min", solution: "Dextrosa 5%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 8mg IV"],
                specialNotes: "D√≠a 15 descanso. Vigilar s√≠ndrome pseudogripal con gemcitabina"
            },
            cisplatin: {
                name: "Cisplatino",
                category: "Diversos tumores",
                schedule: "Cada 21-28 d√≠as",
                drugs: [
                    { name: "Cisplatino", dose: "75-100", unit: "mg/m¬≤", day: "1", infusion: "60-120 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV", "Dexametasona 12mg IV"],
                specialNotes: "Hidrataci√≥n obligatoria pre y post. Monitoreo renal, auditivo y neurol√≥gico"
            },
            carboplatin: {
                name: "Carboplatino",
                category: "Diversos tumores",
                schedule: "Cada 21-28 d√≠as",
                drugs: [
                    { name: "Carboplatino", dose: "AUC 5-6", unit: "", day: "1", infusion: "60 min", solution: "Dextrosa 5%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV"],
                specialNotes: "Dosis seg√∫n f√≥rmula de Calvert. Vigilar trombocitopenia"
            },
            gemcitabine: {
                name: "Gemcitabina",
                category: "P√°ncreas/Pulm√≥n/Vesical",
                schedule: "Semanal x3, descanso 1 semana",
                drugs: [
                    { name: "Gemcitabina", dose: "1000", unit: "mg/m¬≤", day: "1,8,15", infusion: "30 min", solution: "SF 0.9%" }
                ],
                premedication: ["Ondansetr√≥n 8mg IV"],
                specialNotes: "D√≠as 1, 8, 15 cada 28 d√≠as. Vigilar s√≠ndrome pseudogripal"
            }
        };

        // Variables globales
        let currentTab = 'indications';
        let medications = [];
        let customExams = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadURLParams();
            setupEventListeners();
            calculatePatientData();
        });

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Theme selector
            document.getElementById('themeSelector').addEventListener('change', function() {
                document.body.setAttribute('data-theme', this.value);
                localStorage.setItem('theme', this.value);
            });

            // Patient data inputs
            const patientInputs = ['patientName', 'patientAge', 'patientGender', 'patientWeight', 'patientHeight', 'patientCreatinine'];
            patientInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculatePatientData);
            });

            // Treatment scheme change
            document.getElementById('treatmentScheme').addEventListener('change', function() {
                const scheme = this.value;
                const aucSection = document.getElementById('aucSection');
                if (scheme.includes('carboplatin') || scheme === 'tch' || scheme === 'carboplatin-paclitaxel' || scheme === 'gemcitabine-carboplatin') {
                    aucSection.style.display = 'block';
                } else {
                    aucSection.style.display = 'none';
                }
            });

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.getElementById('themeSelector').value = savedTheme;
            document.body.setAttribute('data-theme', savedTheme);
        }

        function loadURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('nombre')) document.getElementById('patientName').value = urlParams.get('nombre');
            if (urlParams.get('edad')) document.getElementById('patientAge').value = urlParams.get('edad');
            if (urlParams.get('genero')) document.getElementById('patientGender').value = urlParams.get('genero');
            if (urlParams.get('peso')) document.getElementById('patientWeight').value = urlParams.get('peso');
            if (urlParams.get('estatura')) document.getElementById('patientHeight').value = urlParams.get('estatura');
            if (urlParams.get('creatinina')) document.getElementById('patientCreatinine').value = urlParams.get('creatinina');
            
            calculatePatientData();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Show/hide panels
            document.querySelectorAll('.tab-content').forEach(panel => panel.classList.add('hidden'));
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');
        }

        function calculatePatientData() {
            const weight = parseFloat(document.getElementById('patientWeight').value) || 0;
            const height = parseFloat(document.getElementById('patientHeight').value) || 0;
            const age = parseFloat(document.getElementById('patientAge').value) || 0;
            const creatinine = parseFloat(document.getElementById('patientCreatinine').value) || 0;
            const gender = document.getElementById('patientGender').value;

            if (weight > 0 && height > 0) {
                // Superficie corporal (Mosteller)
                const bsa = Math.sqrt((weight * height) / 3600);
                document.getElementById('bsaResult').textContent = bsa.toFixed(2) + ' m¬≤';

                // IMC
                const heightM = height / 100;
                const bmi = weight / (heightM * heightM);
                document.getElementById('bmiResult').textContent = bmi.toFixed(1) + ' kg/m¬≤';

                // Depuraci√≥n de creatinina (Cockcroft-Gault con ajuste por obesidad)
                if (age > 0 && creatinine > 0 && gender) {
                    let adjustedWeight = weight;
                    if (bmi > 30) {
                        const idealWeight = gender === 'M' ? 
                            50 + 0.91 * (height - 152.4) : 
                            45.5 + 0.91 * (height - 152.4);
                        adjustedWeight = idealWeight + 0.4 * (weight - idealWeight);
                    }
                    
                    const genderFactor = gender === 'M' ? 1.0 : 0.85;
                    const clcr = ((140 - age) * adjustedWeight * genderFactor) / (72 * creatinine);
                    document.getElementById('clcrResult').textContent = clcr.toFixed(1) + ' mL/min';
                }
            }
        }

        function toggleRequestType() {
            const requestType = document.getElementById('requestType').value;
            const labSection = document.getElementById('laboratory-section');
            const imagingSection = document.getElementById('imaging-section');
            
            if (requestType === 'laboratory') {
                labSection.classList.remove('hidden');
                imagingSection.classList.add('hidden');
            } else {
                labSection.classList.add('hidden');
                imagingSection.classList.remove('hidden');
            }
        }

        function addCustomExam() {
            const input = document.getElementById('customExamInput');
            const examName = input.value.trim();
            
            if (examName) {
                customExams.push(examName);
                
                const examDiv = document.createElement('div');
                examDiv.className = 'custom-exam flex justify-between items-center';
                examDiv.innerHTML = `
                    <span>${examName}</span>
                    <button onclick="removeCustomExam('${examName}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                document.getElementById('customExams').appendChild(examDiv);
                input.value = '';
            }
        }

        function removeCustomExam(examName) {
            customExams = customExams.filter(exam => exam !== examName);
            const examElements = document.querySelectorAll('.custom-exam');
            examElements.forEach(el => {
                if (el.textContent.includes(examName)) {
                    el.remove();
                }
            });
        }

        function addMedication() {
            const medicationId = Date.now();
            medications.push({
                id: medicationId,
                name: '',
                dose: '',
                frequency: '',
                route: 'VO',
                duration: '',
                instructions: ''
            });
            
            renderMedications();
        }

        function removeMedication(medicationId) {
            medications = medications.filter(med => med.id !== medicationId);
            renderMedications();
        }

        function renderMedications() {
            const container = document.getElementById('medications');
            container.innerHTML = '';
            
            medications.forEach(med => {
                const medDiv = document.createElement('div');
                medDiv.className = 'medication-item';
                medDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-medium">Medicamento ${medications.indexOf(med) + 1}</h5>
                        <button onclick="removeMedication(${med.id})" class="btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Medicamento</label>
                            <input type="text" value="${med.name}" onchange="updateMedication(${med.id}, 'name', this.value)" class="input-field w-full" placeholder="Nombre del medicamento">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dosis</label>
                            <input type="text" value="${med.dose}" onchange="updateMedication(${med.id}, 'dose', this.value)" class="input-field w-full" placeholder="500mg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                            <select onchange="updateMedication(${med.id}, 'frequency', this.value)" class="input-field w-full">
                                <option value="">Seleccionar...</option>
                                <option value="Cada 8 horas" ${med.frequency === 'Cada 8 horas' ? 'selected' : ''}>Cada 8 horas</option>
                                <option value="Cada 12 horas" ${med.frequency === 'Cada 12 horas' ? 'selected' : ''}>Cada 12 horas</option>
                                <option value="Cada 24 horas" ${med.frequency === 'Cada 24 horas' ? 'selected' : ''}>Cada 24 horas</option>
                                <option value="En caso necesario" ${med.frequency === 'En caso necesario' ? 'selected' : ''}>En caso necesario</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">V√≠a</label>
                            <select onchange="updateMedication(${med.id}, 'route', this.value)" class="input-field w-full">
                                <option value="VO" ${med.route === 'VO' ? 'selected' : ''}>V√≠a Oral</option>
                                <option value="IV" ${med.route === 'IV' ? 'selected' : ''}>Intravenosa</option>
                                <option value="SC" ${med.route === 'SC' ? 'selected' : ''}>Subcut√°nea</option>
                                <option value="IM" ${med.route === 'IM' ? 'selected' : ''}>Intramuscular</option>
                                <option value="T√≥pica" ${med.route === 'T√≥pica' ? 'selected' : ''}>T√≥pica</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duraci√≥n</label>
                        <input type="text" value="${med.duration}" onchange="updateMedication(${med.id}, 'duration', this.value)" class="input-field w-full" placeholder="7 d√≠as">
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Instrucciones especiales</label>
                        <textarea onchange="updateMedication(${med.id}, 'instructions', this.value)" class="input-field w-full h-20" placeholder="Tomar con alimentos...">${med.instructions}</textarea>
                    </div>
                `;
                container.appendChild(medDiv);
            });
        }

        function updateMedication(medicationId, field, value) {
            const medication = medications.find(med => med.id === medicationId);
            if (medication) {
                medication[field] = value;
            }
        }

        function generateDocument() {
            const patientName = document.getElementById('patientName').value;
            const patientAge = document.getElementById('patientAge').value;
            const patientGender = document.getElementById('patientGender').value === 'M' ? 'Masculino' : 'Femenino';
            const patientWeight = document.getElementById('patientWeight').value;
            const patientHeight = document.getElementById('patientHeight').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const treatmentScheme = document.getElementById('treatmentScheme').value;
            const numberOfCycles = document.getElementById('numberOfCycles').value;
            const additionalNotes = document.getElementById('additionalNotes').value;
            const documentType = document.getElementById('documentType').value;

            if (!patientName || !treatmentScheme) {
                alert('Por favor complete al menos el nombre del paciente y seleccione un esquema de tratamiento.');
                return;
            }

            const scheme = chemotherapySchemes[treatmentScheme];
            if (!scheme) {
                alert('Esquema de tratamiento no encontrado.');
                return;
            }

            let html = '';

            if (documentType === 'medical') {
                html = generateMedicalIndications(patientName, patientAge, patientGender, patientWeight, patientHeight, diagnosis, scheme, numberOfCycles, additionalNotes);
            } else {
                html = generatePatientGuide(patientName, scheme, numberOfCycles);
            }

            document.getElementById('documentPreview').innerHTML = html;
        }

        function generateMedicalIndications(patientName, patientAge, patientGender, patientWeight, patientHeight, diagnosis, scheme, numberOfCycles, additionalNotes) {
            const bsa = Math.sqrt((patientWeight * patientHeight) / 3600).toFixed(2);
            const today = new Date().toLocaleDateString('es-ES');

            let drugTable = '';
            scheme.drugs.forEach(drug => {
                let calculatedDose = drug.dose;
                if (drug.unit === 'mg/m¬≤') {
                    calculatedDose = (parseFloat(drug.dose) * parseFloat(bsa)).toFixed(1);
                } else if (drug.unit === 'mg/kg') {
                    calculatedDose = (parseFloat(drug.dose) * parseFloat(patientWeight)).toFixed(1);
                } else if (drug.dose.includes('AUC')) {
                    const targetAUC = document.getElementById('targetAUC').value || '6';
                    const age = parseFloat(document.getElementById('patientAge').value);
                    const weight = parseFloat(document.getElementById('patientWeight').value);
                    const creatinine = parseFloat(document.getElementById('patientCreatinine').value);
                    const gender = document.getElementById('patientGender').value;
                    const height = parseFloat(document.getElementById('patientHeight').value);
                    
                    if (age && weight && creatinine && gender && height) {
                        calculatedDose = calculateCarboplatin(targetAUC, age, weight, creatinine, gender, height).toFixed(0);
                    } else {
                        calculatedDose = `AUC ${targetAUC}`;
                    }
                }

                drugTable += `
                    <tr>
                        <td class="border px-3 py-2">${drug.name}</td>
                        <td class="border px-3 py-2">${calculatedDose} ${drug.unit === '' ? 'mg' : drug.unit}</td>
                        <td class="border px-3 py-2">D√≠a ${drug.day}</td>
                        <td class="border px-3 py-2">${drug.infusion}</td>
                        <td class="border px-3 py-2">${drug.solution}</td>
                    </tr>
                `;
            });

            let premedication = '';
            scheme.premedication.forEach(med => {
                premedication += `<li>${med}</li>`;
            });

            return `
                <div class="medical-document bg-white p-6 rounded-lg shadow-lg">
                    <div class="header border-b-2 border-red-600 pb-4 mb-6">
                        <div class="flex justify-between items-center">
                            <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" class="h-16">
                            <div class="text-right">
                                <h1 class="text-2xl font-bold text-red-600">INDICACIONES M√âDICAS</h1>
                                <p class="text-sm text-gray-600">Fecha: ${today}</p>
                            </div>
                        </div>
                    </div>

                    <div class="patient-info mb-6 bg-gray-50 p-4 rounded">
                        <h2 class="text-lg font-semibold mb-3">DATOS DEL PACIENTE</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <p><strong>Nombre:</strong> ${patientName}</p>
                            <p><strong>Edad:</strong> ${patientAge} a√±os</p>
                            <p><strong>Sexo:</strong> ${patientGender}</p>
                            <p><strong>Peso:</strong> ${patientWeight} kg</p>
                            <p><strong>Estatura:</strong> ${patientHeight} cm</p>
                            <p><strong>SC:</strong> ${bsa} m¬≤</p>
                        </div>
                        ${diagnosis ? `<p class="mt-2"><strong>Diagn√≥stico:</strong> ${diagnosis}</p>` : ''}
                    </div>

                    <div class="treatment-info mb-6">
                        <h2 class="text-lg font-semibold mb-3">ESQUEMA DE TRATAMIENTO</h2>
                        <p><strong>Protocolo:</strong> ${scheme.name}</p>
                        <p><strong>Categor√≠a:</strong> ${scheme.category}</p>
                        <p><strong>Frecuencia:</strong> ${scheme.schedule}</p>
                        <p><strong>N√∫mero de ciclos:</strong> ${numberOfCycles || 'A definir'}</p>
                    </div>

                    <div class="medications mb-6">
                        <h2 class="text-lg font-semibold mb-3">MEDICAMENTOS</h2>
                        <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-red-50">
                                <tr>
                                    <th class="border px-3 py-2 text-left">Medicamento</th>
                                    <th class="border px-3 py-2 text-left">Dosis</th>
                                    <th class="border px-3 py-2 text-left">D√≠as</th>
                                    <th class="border px-3 py-2 text-left">Infusi√≥n</th>
                                    <th class="border px-3 py-2 text-left">Soluci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${drugTable}
                            </tbody>
                        </table>
                    </div>

                    <div class="premedication mb-6">
                        <h2 class="text-lg font-semibold mb-3">PREMEDICACI√ìN</h2>
                        <ul class="list-disc list-inside">
                            ${premedication}
                        </ul>
                    </div>

                    ${scheme.specialNotes ? `
                        <div class="special-notes mb-6">
                            <h2 class="text-lg font-semibold mb-3">NOTAS ESPECIALES</h2>
                            <p class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">${scheme.specialNotes}</p>
                        </div>
                    ` : ''}

                    ${additionalNotes ? `
                        <div class="additional-notes mb-6">
                            <h2 class="text-lg font-semibold mb-3">NOTAS ADICIONALES</h2>
                            <p class="bg-blue-50 p-3 rounded border-l-4 border-blue-400">${additionalNotes}</p>
                        </div>
                    ` : ''}

                    <div class="footer mt-8 border-t pt-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">OncoTech - Centro de Oncolog√≠a</p>
                            <p class="text-sm text-gray-600">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129.71.71</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePatientGuide(patientName, scheme, numberOfCycles) {
            return `
                <div class="patient-guide bg-white p-6 rounded-lg shadow-lg">
                    <div class="header border-b-2 border-red-600 pb-4 mb-6">
                        <div class="flex justify-between items-center">
                            <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" class="h-16">
                            <div class="text-right">
                                <h1 class="text-2xl font-bold text-red-600">GU√çA PARA EL PACIENTE</h1>
                                <p class="text-sm text-gray-600">Quimioterapia: ${scheme.name}</p>
                            </div>
                        </div>
                    </div>

                    <div class="patient-info mb-6">
                        <h2 class="text-lg font-semibold mb-3">Estimado(a) ${patientName}</h2>
                        <p class="mb-4">Esta gu√≠a le ayudar√° a entender su tratamiento de quimioterapia y c√≥mo cuidarse durante el mismo.</p>
                    </div>

                    <div class="treatment-overview mb-6">
                        <h2 class="text-lg font-semibold mb-3 text-red-600">SU TRATAMIENTO</h2>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Esquema:</strong> ${scheme.name}</p>
                            <p><strong>Frecuencia:</strong> ${scheme.schedule}</p>
                            <p><strong>N√∫mero de ciclos:</strong> ${numberOfCycles || 'Seg√∫n evoluci√≥n'}</p>
                        </div>
                    </div>

                    <div class="what-to-expect mb-6">
                        <h2 class="text-lg font-semibold mb-3 text-red-600">QU√â ESPERAR</h2>
                        <div class="space-y-3">
                            <div class="bg-blue-50 p-3 rounded">
                                <h4 class="font-medium">El d√≠a del tratamiento:</h4>
                                <ul class="list-disc list-inside mt-2 text-sm">
                                    <li>Llegue con 30 minutos de anticipaci√≥n</li>
                                    <li>Se tomar√°n signos vitales y an√°lisis de sangre</li>
                                    <li>Recibir√° medicamentos para prevenir efectos secundarios</li>
                                    <li>La infusi√≥n puede durar varias horas</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="side-effects mb-6">
                        <h2 class="text-lg font-semibold mb-3 text-red-600">EFECTOS SECUNDARIOS COMUNES</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-yellow-50 p-3 rounded">
                                <h4 class="font-medium">N√°usea y v√≥mito:</h4>
                                <ul class="text-sm mt-1">
                                    <li>‚Ä¢ Tome los medicamentos antiem√©ticos seg√∫n indicaci√≥n</li>
                                    <li>‚Ä¢ Coma porciones peque√±as y frecuentes</li>
                                    <li>‚Ä¢ Evite olores fuertes</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded">
                                <h4 class="font-medium">Fatiga:</h4>
                                <ul class="text-sm mt-1">
                                    <li>‚Ä¢ Descanse cuando lo necesite</li>
                                    <li>‚Ä¢ Mantenga actividad ligera</li>
                                    <li>‚Ä¢ Pida ayuda con tareas pesadas</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="laboratory-timing mb-6 bg-orange-50 p-4 rounded border-l-4 border-orange-400">
                        <h2 class="text-lg font-semibold mb-3 text-orange-700">IMPORTANTE: CU√ÅNDO HACERSE LABORATORIOS</h2>
                        <div class="space-y-2">
                            <p><strong>‚úÖ S√ç hacerse laboratorios:</strong></p>
                            <ul class="list-disc list-inside ml-4 text-sm">
                                <li>1-3 d√≠as antes del siguiente ciclo</li>
                                <li>Si tiene fiebre, sangrado o debilidad extrema</li>
                                <li>Cuando su onc√≥logo lo solicite espec√≠ficamente</li>
                            </ul>
                            <p class="mt-3"><strong>‚ùå NO hacerse laboratorios:</strong></p>
                            <ul class="list-disc list-inside ml-4 text-sm">
                                <li>Entre los d√≠as 5-14 despu√©s de la quimioterapia (per√≠odo de nadir)</li>
                                <li>"Por curiosidad" o ansiedad</li>
                                <li>A solicitud de otros m√©dicos sin coordinaci√≥n con oncolog√≠a</li>
                            </ul>
                            <p class="mt-3 text-sm"><strong>¬øPor qu√©?</strong> Los valores bajos en estos d√≠as son esperados y normales. Hacerse laboratorios en el momento incorrecto puede causar alarma innecesaria y decisiones err√≥neas sobre su tratamiento.</p>
                        </div>
                    </div>

                    <div class="when-to-call mb-6">
                        <h2 class="text-lg font-semibold mb-3 text-red-600">CU√ÅNDO CONTACTARNOS</h2>
                        <div class="bg-red-50 p-4 rounded border-l-4 border-red-400">
                            <p class="font-medium mb-2">Llame inmediatamente si presenta:</p>
                            <ul class="list-disc list-inside text-sm space-y-1">
                                <li>Fiebre mayor a 38¬∞C</li>
                                <li>Escalofr√≠os o temblores</li>
                                <li>Sangrado inusual</li>
                                <li>Dificultad para respirar</li>
                                <li>V√≥mito persistente que impide tomar l√≠quidos</li>
                                <li>Diarrea severa (m√°s de 6 evacuaciones al d√≠a)</li>
                                <li>Dolor severo</li>
                            </ul>
                        </div>
                    </div>

                    <div class="nutrition mb-6">
                        <h2 class="text-lg font-semibold mb-3 text-red-600">RECOMENDACIONES NUTRICIONALES</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 p-3 rounded">
                                <h4 class="font-medium text-green-700">Alimentos recomendados:</h4>
                                <ul class="text-sm mt-1">
                                    <li>‚Ä¢ Prote√≠nas magras bien cocidas</li>
                                    <li>‚Ä¢ Frutas y verduras lavadas</li>
                                    <li>‚Ä¢ Muchos l√≠quidos</li>
                                    <li>‚Ä¢ Cereales integrales</li>
                                </ul>
                            </div>
                            <div class="bg-red-50 p-3 rounded">
                                <h4 class="font-medium text-red-700">Evitar:</h4>
                                <ul class="text-sm mt-1">
                                    <li>‚Ä¢ Carnes crudas o poco cocidas</li>
                                    <li>‚Ä¢ Huevos crudos</li>
                                    <li>‚Ä¢ Productos l√°cteos no pasteurizados</li>
                                    <li>‚Ä¢ Frutas sin lavar</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="contact-info bg-gray-50 p-4 rounded">
                        <h2 class="text-lg font-semibold mb-3">INFORMACI√ìN DE CONTACTO</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p><strong>OncoTech - Centro de Oncolog√≠a</strong></p>
                                <p>Normal Urbana 1367, Colonia Perla</p>
                                <p>La Paz, Baja California Sur</p>
                            </div>
                            <div>
                                <p><strong>Tel√©fono:</strong> (612) 129.71.71</p>
                                <p><strong>Horario:</strong> Lunes a Viernes 9:00-21:00</p>
                                <p><strong>Importante:</strong> Solo con previa cita</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateRequest() {
            const requestType = document.getElementById('requestType').value;
            const patientName = document.getElementById('patientName').value;
            const patientAge = document.getElementById('patientAge').value;
            const diagnosis = document.getElementById('diagnosis').value;

            if (!patientName) {
                alert('Por favor ingrese el nombre del paciente.');
                return;
            }

            let html = '';

            if (requestType === 'laboratory') {
                html = generateLabRequest(patientName, patientAge, diagnosis);
            } else {
                html = generateImagingRequest(patientName, patientAge, diagnosis);
            }

            document.getElementById('documentPreview').innerHTML = html;
        }

        function generateLabRequest(patientName, patientAge, diagnosis) {
            const today = new Date().toLocaleDateString('es-ES');
            
            // Obtener ex√°menes seleccionados
            const selectedExams = [];
            document.querySelectorAll('#laboratory-section input[type="checkbox"]:checked').forEach(checkbox => {
                selectedExams.push(checkbox.parentElement.textContent.trim());
            });

            // Agregar ex√°menes personalizados
            customExams.forEach(exam => {
                selectedExams.push(exam);
            });

            let examsList = '';
            selectedExams.forEach(exam => {
                examsList += `<li class="mb-1">‚òê ${exam}</li>`;
            });

            return `
                <div class="lab-request bg-white p-6 rounded-lg shadow-lg">
                    <div class="header border-b-2 border-red-600 pb-4 mb-6">
                        <div class="flex justify-between items-center">
                            <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" class="h-16">
                            <div class="text-right">
                                <h1 class="text-2xl font-bold text-red-600">SOLICITUD DE LABORATORIO</h1>
                                <p class="text-sm text-gray-600">Fecha: ${today}</p>
                            </div>
                        </div>
                    </div>

                    <div class="patient-info mb-6 bg-gray-50 p-4 rounded">
                        <h2 class="text-lg font-semibold mb-3">DATOS DEL PACIENTE</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <p><strong>Nombre:</strong> ${patientName}</p>
                            <p><strong>Edad:</strong> ${patientAge} a√±os</p>
                            ${diagnosis ? `<p class="col-span-2"><strong>Diagn√≥stico:</strong> ${diagnosis}</p>` : ''}
                        </div>
                    </div>

                    <div class="exams-section mb-6">
                        <h2 class="text-lg font-semibold mb-3">EX√ÅMENES SOLICITADOS</h2>
                        <ul class="space-y-1">
                            ${examsList}
                        </ul>
                    </div>

                    <div class="timing-instructions mb-6 bg-orange-50 p-4 rounded border-l-4 border-orange-400">
                        <h2 class="text-lg font-semibold mb-3 text-orange-700">INSTRUCCIONES IMPORTANTES</h2>
                        <div class="space-y-2 text-sm">
                            <p><strong>TIMING CORRECTO:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Realizar 1-3 d√≠as antes del siguiente ciclo de quimioterapia</li>
                                <li>NO realizar entre d√≠as 5-14 post-quimioterapia (per√≠odo de nadir)</li>
                                <li>En caso de s√≠ntomas (fiebre, sangrado) realizar inmediatamente</li>
                            </ul>
                            <p class="mt-3"><strong>PREPARACI√ìN:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Ayuno de 8-12 horas para perfil lip√≠dico</li>
                                <li>Hidrataci√≥n adecuada antes del estudio</li>
                                <li>Suspender medicamentos seg√∫n indicaci√≥n m√©dica</li>
                            </ul>
                        </div>
                    </div>

                    <div class="footer mt-8 border-t pt-4">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm"><strong>M√©dico Solicitante:</strong></p>
                                <div class="border-b border-gray-400 mt-8 mb-2"></div>
                                <p class="text-xs text-center">Firma y Sello</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">OncoTech - Centro de Oncolog√≠a</p>
                                <p class="text-sm text-gray-600">Tel: (612) 129.71.71</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateImagingRequest(patientName, patientAge, diagnosis) {
            const imagingType = document.getElementById('imagingType').value;
            const anatomicRegion = document.getElementById('anatomicRegion').value;
            const withContrast = document.getElementById('withContrast').checked;
            const creatinine = document.getElementById('patientCreatinine').value;
            const today = new Date().toLocaleDateString('es-ES');

            const imagingTypes = {
                tc: 'Tomograf√≠a Computarizada',
                rm: 'Resonancia Magn√©tica',
                us: 'Ultrasonido',
                rx: 'Radiograf√≠a',
                pet: 'PET-CT'
            };

            const regions = {
                torax: 'T√≥rax',
                abdomen: 'Abdomen',
                pelvis: 'Pelvis',
                tap: 'T√≥rax, Abdomen y Pelvis',
                craneo: 'Cr√°neo',
                cuello: 'Cuello',
                extremidades: 'Extremidades'
            };

            let contrastWarning = '';
            if (withContrast && (imagingType === 'tc' || imagingType === 'rm')) {
                contrastWarning = `
                    <div class="contrast-warning mb-6 bg-yellow-50 p-4 rounded border-l-4 border-yellow-400">
                        <h2 class="text-lg font-semibold mb-3 text-yellow-700">ALERTA - CONTRASTE</h2>
                        <p><strong>Creatinina s√©rica requerida ‚â§ 1.5 mg/dL</strong></p>
                        ${creatinine ? `<p>Creatinina actual: ${creatinine} mg/dL</p>` : '<p>‚ö†Ô∏è Verificar creatinina antes del estudio</p>'}
                        <div class="mt-3 text-sm">
                            <p><strong>Preparaci√≥n necesaria:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Ayuno 4-6 horas</li>
                                <li>Hidrataci√≥n pre y post estudio</li>
                                <li>Suspender metformina 48h previas (si aplica)</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="imaging-request bg-white p-6 rounded-lg shadow-lg">
                    <div class="header border-b-2 border-red-600 pb-4 mb-6">
                        <div class="flex justify-between items-center">
                            <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" class="h-16">
                            <div class="text-right">
                                <h1 class="text-2xl font-bold text-red-600">SOLICITUD DE ESTUDIO DE IMAGEN</h1>
                                <p class="text-sm text-gray-600">Fecha: ${today}</p>
                            </div>
                        </div>
                    </div>

                    <div class="patient-info mb-6 bg-gray-50 p-4 rounded">
                        <h2 class="text-lg font-semibold mb-3">DATOS DEL PACIENTE</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <p><strong>Nombre:</strong> ${patientName}</p>
                            <p><strong>Edad:</strong> ${patientAge} a√±os</p>
                            ${diagnosis ? `<p class="col-span-2"><strong>Diagn√≥stico:</strong> ${diagnosis}</p>` : ''}
                        </div>
                    </div>

                    <div class="study-info mb-6">
                        <h2 class="text-lg font-semibold mb-3">ESTUDIO SOLICITADO</h2>
                        <div class="bg-blue-50 p-4 rounded">
                            <p class="text-xl font-medium">${imagingTypes[imagingType]} de ${regions[anatomicRegion]}</p>
                            <p class="mt-2">${withContrast ? '‚úÖ CON CONTRASTE' : '‚ùå SIN CONTRASTE'}</p>
                        </div>
                    </div>

                    ${contrastWarning}

                    <div class="clinical-info mb-6">
                        <h2 class="text-lg font-semibold mb-3">INFORMACI√ìN CL√çNICA</h2>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Indicaci√≥n:</strong> Seguimiento oncol√≥gico</p>
                            <p><strong>Objetivo:</strong> Evaluaci√≥n de respuesta a tratamiento / Estadificaci√≥n</p>
                        </div>
                    </div>

                    <div class="preparation mb-6">
                        <h2 class="text-lg font-semibold mb-3">PREPARACI√ìN DEL PACIENTE</h2>
                        <div class="space-y-2 text-sm">
                            ${imagingType === 'tc' || imagingType === 'rm' ? `
                                <div class="bg-green-50 p-3 rounded">
                                    <p><strong>Preparaci√≥n general:</strong></p>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>Remover objetos met√°licos</li>
                                        <li>Ropa c√≥moda sin metales</li>
                                        ${imagingType === 'rm' ? '<li>Informar sobre marcapasos/implantes met√°licos</li>' : ''}
                                    </ul>
                                </div>
                            ` : ''}
                            ${imagingType === 'pet' ? `
                                <div class="bg-green-50 p-3 rounded">
                                    <p><strong>Preparaci√≥n PET-CT:</strong></p>
                                    <ul class="list-disc list-inside ml-4">
                                        <li>Ayuno 6 horas m√≠nimo</li>
                                        <li>Glucosa < 150 mg/dL</li>
                                        <li>Evitar ejercicio 24h previas</li>
                                        <li>Hidrataci√≥n abundante post-estudio</li>
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="footer mt-8 border-t pt-4">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm"><strong>M√©dico Solicitante:</strong></p>
                                <div class="border-b border-gray-400 mt-8 mb-2"></div>
                                <p class="text-xs text-center">Firma y Sello</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">OncoTech - Centro de Oncolog√≠a</p>
                                <p class="text-sm text-gray-600">Tel: (612) 129.71.71</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePrescription() {
            const patientName = document.getElementById('patientName').value;
            const patientAge = document.getElementById('patientAge').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const today = new Date().toLocaleDateString('es-ES');

            if (!patientName || medications.length === 0) {
                alert('Por favor ingrese el nombre del paciente y agregue al menos un medicamento.');
                return;
            }

            let medicationsList = '';
            medications.forEach((med, index) => {
                if (med.name) {
                    medicationsList += `
                        <div class="medication-item bg-gray-50 p-3 rounded mb-3">
                            <h4 class="font-medium text-blue-700">${index + 1}. ${med.name}</h4>
                            <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                                <p><strong>Dosis:</strong> ${med.dose || 'No especificada'}</p>
                                <p><strong>V√≠a:</strong> ${med.route || 'VO'}</p>
                                <p><strong>Frecuencia:</strong> ${med.frequency || 'No especificada'}</p>
                                <p><strong>Duraci√≥n:</strong> ${med.duration || 'No especificada'}</p>
                            </div>
                            ${med.instructions ? `<p class="mt-2 text-sm"><strong>Instrucciones:</strong> ${med.instructions}</p>` : ''}
                        </div>
                    `;
                }
            });

            const html = `
                <div class="prescription bg-white p-6 rounded-lg shadow-lg">
                    <div class="header border-b-2 border-red-600 pb-4 mb-6">
                        <div class="flex justify-between items-center">
                            <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" class="h-16">
                            <div class="text-right">
                                <h1 class="text-2xl font-bold text-red-600">RECETA M√âDICA</h1>
                                <p class="text-sm text-gray-600">Fecha: ${today}</p>
                            </div>
                        </div>
                    </div>

                    <div class="patient-info mb-6 bg-gray-50 p-4 rounded">
                        <h2 class="text-lg font-semibold mb-3">DATOS DEL PACIENTE</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <p><strong>Nombre:</strong> ${patientName}</p>
                            <p><strong>Edad:</strong> ${patientAge} a√±os</p>
                            ${diagnosis ? `<p class="col-span-2"><strong>Diagn√≥stico:</strong> ${diagnosis}</p>` : ''}
                        </div>
                    </div>

                    <div class="medications-section mb-6">
                        <h2 class="text-lg font-semibold mb-4">MEDICAMENTOS PRESCRITOS</h2>
                        ${medicationsList}
                    </div>

                    <div class="general-instructions mb-6 bg-blue-50 p-4 rounded border-l-4 border-blue-400">
                        <h2 class="text-lg font-semibold mb-3 text-blue-700">INSTRUCCIONES GENERALES</h2>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>Tome los medicamentos exactamente como se indica</li>
                            <li>No suspenda el tratamiento sin consultar a su m√©dico</li>
                            <li>Si olvida una dosis, t√≥mela tan pronto como lo recuerde</li>
                            <li>Mantenga los medicamentos en lugar fresco y seco</li>
                            <li>Informe cualquier efecto secundario inusual</li>
                        </ul>
                    </div>

                    <div class="footer mt-8 border-t pt-4">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <p class="text-sm"><strong>M√©dico Tratante:</strong></p>
                                <div class="border-b border-gray-400 mt-8 mb-2"></div>
                                <p class="text-xs text-center">Firma y Sello M√©dico</p>
                                <p class="text-xs text-center">C√©dula Profesional</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">OncoTech - Centro de Oncolog√≠a</p>
                                <p class="text-sm text-gray-600">Normal Urbana 1367, Colonia Perla, La Paz, BCS</p>
                                <p class="text-sm text-gray-600">Tel: (612) 129.71.71</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('documentPreview').innerHTML = html;
        }

        function generateGuide() {
            const guideType = document.getElementById('guideType').value;
            const guideScheme = document.getElementById('guideScheme').value;
            const patientName = document.getElementById('patientName').value;

            if (!patientName) {
                alert('Por favor ingrese el nombre del paciente.');
                return;
            }

            const scheme = guideScheme ? chemotherapySchemes[guideScheme] : null;
            const html = generatePatientGuide(patientName, scheme || { name: 'Quimioterapia', schedule: 'Seg√∫n indicaci√≥n m√©dica' }, '');

            document.getElementById('documentPreview').innerHTML = html;
        }

        function calculateCarboplatin(targetAUC, age, weight, creatinine, gender, height) {
            if (!targetAUC || targetAUC <= 0) return 0;
            
            const bmi = weight / Math.pow(height / 100, 2);
            let adjustedWeight = weight;
            
            if (bmi > 30) {
                const idealWeight = gender === 'M' ? 
                    50 + 0.91 * (height - 152.4) : 
                    45.5 + 0.91 * (height - 152.4);
                adjustedWeight = idealWeight + 0.4 * (weight - idealWeight);
            }
            
            const genderFactor = gender === 'M' ? 1.0 : 0.85;
            const clcr = ((140 - age) * adjustedWeight * genderFactor) / (72 * creatinine);
            
            if (clcr === 0) return 0;
            
            const dose = targetAUC * (clcr + 25);
            return Math.round(dose);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const preview = document.getElementById('documentPreview');
            
            if (preview.innerHTML.includes('Complete los datos')) {
                alert('Por favor genere un documento antes de exportar a PDF.');
                return;
            }

            // Crear una versi√≥n limpia para PDF
            const printContent = preview.cloneNode(true);
            
            // Remover elementos no necesarios para PDF
            printContent.querySelectorAll('.no-print').forEach(el => el.remove());
            
            // Crear PDF
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Configurar HTML para PDF
            const opt = {
                callback: function (pdf) {
                    pdf.save(`OncoGuia_${document.getElementById('patientName').value || 'Paciente'}_${new Date().toISOString().slice(0,10)}.pdf`);
                },
                x: 10,
                y: 10,
                width: 190,
                windowWidth: 800
            };

            pdf.html(printContent, opt);
        }

        function exportJSON() {
            const patientData = {
                name: document.getElementById('patientName').value,
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                weight: document.getElementById('patientWeight').value,
                height: document.getElementById('patientHeight').value,
                creatinine: document.getElementById('patientCreatinine').value,
                diagnosis: document.getElementById('diagnosis').value
            };

            const treatmentData = {
                scheme: document.getElementById('treatmentScheme').value,
                cycles: document.getElementById('numberOfCycles').value,
                notes: document.getElementById('additionalNotes').value
            };

            const exportData = {
                patient: patientData,
                treatment: treatmentData,
                medications: medications,
                customExams: customExams,
                generatedDate: new Date().toISOString(),
                clinic: {
                    name: "OncoTech - Centro de Oncolog√≠a",
                    address: "Normal Urbana 1367, Colonia Perla, La Paz, BCS",
                    phone: "(612) 129.71.71"
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `OncoGuia_${patientData.name || 'Paciente'}_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }

        // Inicializar medicamentos vac√≠o
        if (medications.length === 0) {
            addMedication();
        }

        // Duplicar opciones de esquema en gu√≠a
        document.addEventListener('DOMContentLoaded', function() {
            const treatmentSelect = document.getElementById('treatmentScheme');
            const guideSelect = document.getElementById('guideScheme');
            
            if (treatmentSelect && guideSelect) {
                guideSelect.innerHTML = treatmentSelect.innerHTML;
            }
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"950e63ff09483ac0","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDt6%2B7y%2F2Gkrjw3QYW%2BEmPnCjI4RaoTjEEV9aUc2pli4Rfxzt0xlbcZPX2dDd%2Fm6CyZP7bOlKCxOsppccDcGvBI54oSj%2BkQf7IuoGpuHFiolAvTM%2FQYZfTeVNIkRHJvvlIvXIHKZi8w6Z5vr%2B2XEJg44FDI%2FIMvkQfHUPfE%2BhatlcvmIqh%2F259L7XgqxTaISXsjlAetkLn%2FjzaDaT%2F3gxZ3DXDTwnHG5aSC51sZSBuQHXuAqnAAiFC3vzeM5aWxhrWuGlefvKCNezhG8wfJtneM7Ktx8TqS1R%2FnwoWDm0%2FmwHF47Wyuo7GeJLgs%2F%2F%2B1IZbVF7%2BzRmgzC8J4RE6SvaRBx8o4Aiv0j6GS4pAzMx43z0hV%2F5u2cbwx2ldCEBKkyq%2BD3eUjMLc0e41vsQY9lYuS9Gt3sVw3e%2BGNcP6GoTsrDkiBA8ODfJd1aCYGDiL6bDApw8srjPLgGToLIKkmROgbT1eIhSSm1f25N92B%2BxiQ4XTSqTUv2PhFmcOPyZOQKObsM0iw%2F%2B%2FUsp8UnhEUJ8PPw%3D";
        window.__genspark_locale = "es-ES";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDt6+7y/2Gkrjw3QYW+EmPnCjI4RaoTjEEV9aUc2pli4Rfxzt0xlbcZPX2dDd/m6CyZP7bOlKCxOsppccDcGvBI54oSj+kQf7IuoGpuHFiolAvTM/QYZfTeVNIkRHJvvlIvXIHKZi8w6Z5vr+2XEJg44FDI/IMvkQfHUPfE+hatlcvmIqh/259L7XgqxTaISXsjlAetkLn/jzaDaT/3gxZ3DXDTwnHG5aSC51sZSBuQHXuAqnAAiFC3vzeM5aWxhrWuGlefvKCNezhG8wfJtneM7Ktx8TqS1R/nwoWDm0/mwHF47Wyuo7GeJLgs//+1IZbVF7+zRmgzC8J4RE6SvaRBx8o4Aiv0j6GS4pAzMx43z0hV/5u2cbwx2ldCEBKkyq+D3eUjMLc0e41vsQY9lYuS9Gt3sVw3e+GNcP6GoTsrDkiBA8ODfJd1aCYGDiL6bDApw8srjPLgGToLIKkmROgbT1eIhSSm1f25N92B+xiQ4XTSqTUv2PhFmcOPyZOQKObsM0iw/+/Usp8UnhEUJ8PPw=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
