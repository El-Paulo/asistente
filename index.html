<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OncoGu√≠a Pro v8.0 - OncoTech</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Calibri', 'Arial', 'Inter', sans-serif;
        }
        
        .dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #e5e5e5;
            --border-color: #4a4a4a;
            --accent-color: #dc2626;
        }
        
        .light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #dc2626;
        }
        
        .theme-bg-primary { background-color: var(--bg-primary); }
        .theme-bg-secondary { background-color: var(--bg-secondary); }
        .theme-bg-tertiary { background-color: var(--bg-tertiary); }
        .theme-text-primary { color: var(--text-primary); }
        .theme-text-secondary { color: var(--text-secondary); }
        .theme-border { border-color: var(--border-color); }
        .theme-accent { background-color: var(--accent-color); }
        
        .preview-container {
            min-height: 600px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow-y: auto;
            background: white;
            padding: 20px;
        }
        
        .document-preview {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            color: black;
            line-height: 1.6;
        }
        
        .document-preview h1 { font-size: 24px; font-weight: bold; margin-bottom: 16px; }
        .document-preview h2 { font-size: 20px; font-weight: bold; margin: 16px 0 12px 0; }
        .document-preview h3 { font-size: 16px; font-weight: bold; margin: 12px 0 8px 0; }
        .document-preview p { margin-bottom: 8px; }
        .document-preview ul { margin-left: 20px; margin-bottom: 12px; }
        .document-preview li { margin-bottom: 4px; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
    </style>
</head>
<body class="light theme-bg-primary theme-text-primary min-h-screen">
    <!-- Header -->
    <header class="theme-bg-secondary border-b-4 border-red-600 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech Logo" class="h-12 w-auto">
                        <div class="h-12 w-1 bg-gradient-to-b from-red-600 to-red-800 rounded"></div>
                        <div>
                            <h1 class="text-2xl font-bold theme-text-primary">OncoGu√≠a Pro v8.0</h1>
                            <p class="text-sm theme-text-secondary">Sistema de Documentos M√©dicos Oncol√≥gicos</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right text-sm theme-text-secondary">
                        <div class="font-semibold">OncoTech - Centro de Oncolog√≠a</div>
                        <div>Normal Urbana 1367, Colonia Perla, La Paz, BCS</div>
                        <div>Tel: (612) 129-71-71 | L-V 9:00-21:00</div>
                        <div class="text-xs text-red-600">Solo con previa cita ‚Ä¢ No urgencias</div>
                    </div>
                    <select id="themeSelector" class="px-3 py-2 border theme-border rounded-lg theme-bg-tertiary theme-text-primary">
                        <option value="light">Modo Claro</option>
                        <option value="dark">Modo Oscuro</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Left Panel - Forms -->
            <div class="theme-bg-secondary rounded-lg shadow-lg p-6">
                
                <!-- Patient Data -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold theme-text-primary mb-4 flex items-center">
                        <i class="fas fa-user-injured mr-2 text-red-600"></i>
                        Datos del Paciente
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Nombre Completo *</label>
                            <input type="text" id="patientName" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: Mar√≠a Garc√≠a L√≥pez">
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Edad (a√±os) *</label>
                            <input type="number" id="patientAge" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" min="0" max="120">
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Sexo *</label>
                            <select id="patientGender" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                                <option value="">Seleccionar...</option>
                                <option value="M">Masculino</option>
                                <option value="F">Femenino</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Peso (kg) *</label>
                            <input type="number" id="patientWeight" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" min="20" max="300" step="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Estatura (cm) *</label>
                            <input type="number" id="patientHeight" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" min="100" max="250">
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Creatinina (mg/dL)</label>
                            <input type="number" id="patientCreatinine" class="input-field w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" min="0.1" max="15" step="0.1">
                        </div>
                    </div>
                    
                    <!-- Automatic Calculations -->
                    <div class="mt-4 p-3 theme-bg-tertiary rounded-lg">
                        <h3 class="text-sm font-medium theme-text-primary mb-2">C√°lculos Autom√°ticos</h3>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="theme-text-secondary">SC:</span>
                                <span id="bsaValue" class="font-mono theme-text-primary">-- m¬≤</span>
                            </div>
                            <div>
                                <span class="theme-text-secondary">IMC:</span>
                                <span id="bmiValue" class="font-mono theme-text-primary">-- kg/m¬≤</span>
                            </div>
                            <div>
                                <span class="theme-text-secondary">ClCr (CG):</span>
                                <span id="crclValue" class="font-mono theme-text-primary">-- mL/min</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Type Selector -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold theme-text-primary mb-4 flex items-center">
                        <i class="fas fa-file-medical mr-2 text-red-600"></i>
                        Tipo de Documento
                    </h2>
                    <select id="documentType" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary text-lg">
                        <option value="">Seleccione el tipo de documento...</option>
                        <option value="chemotherapy">üíä Gu√≠a de Quimioterapia</option>
                        <option value="prescription">üìù Receta M√©dica</option>
                        <option value="laboratory">üß™ Solicitud de Laboratorio</option>
                        <option value="imaging">üì∏ Solicitud de Imagen</option>
                        <option value="instructions">üìã Indicaciones M√©dicas</option>
                    </select>
                </div>

                <!-- Dynamic Content Area -->
                <div id="dynamicContent" class="fade-in">
                    <div class="text-center py-8 theme-text-secondary">
                        <i class="fas fa-arrow-up text-4xl mb-4"></i>
                        <p>Seleccione un tipo de documento para continuar</p>
                    </div>
                </div>

            </div>

            <!-- Right Panel - Preview -->
            <div class="theme-bg-secondary rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold theme-text-primary flex items-center">
                        <i class="fas fa-eye mr-2 text-red-600"></i>
                        Previsualizaci√≥n del Documento
                    </h2>
                    <div class="flex space-x-2">
                        <button id="generateBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-magic mr-2"></i>Generar
                        </button>
                        <button id="pdfBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-file-pdf mr-2"></i>PDF
                        </button>
                        <button id="emailBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-envelope mr-2"></i>Email
                        </button>
                        <button id="jsonBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-code mr-2"></i>JSON
                        </button>
                    </div>
                </div>
                
                <div class="preview-container">
                    <div id="documentPreview" class="document-preview">
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-file-alt text-6xl mb-4"></i>
                            <p class="text-lg">Complete los datos del paciente y seleccione un tipo de documento para ver la previsualizaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDocumentData = {};
        
        // URL Parameters handling
        function loadURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('nombre')) document.getElementById('patientName').value = urlParams.get('nombre');
            if (urlParams.get('edad')) document.getElementById('patientAge').value = urlParams.get('edad');
            if (urlParams.get('genero')) document.getElementById('patientGender').value = urlParams.get('genero');
            if (urlParams.get('peso')) document.getElementById('patientWeight').value = urlParams.get('peso');
            if (urlParams.get('estatura')) document.getElementById('patientHeight').value = urlParams.get('estatura');
            if (urlParams.get('creatinina')) document.getElementById('patientCreatinine').value = urlParams.get('creatinina');
            
            calculateAutomaticValues();
        }
        
        // Theme handling
        function initializeTheme() {
            const themeSelector = document.getElementById('themeSelector');
            const savedTheme = localStorage.getItem('oncoguia-theme') || 'light';
            
            themeSelector.value = savedTheme;
            applyTheme(savedTheme);
            
            themeSelector.addEventListener('change', (e) => {
                const theme = e.target.value;
                applyTheme(theme);
                localStorage.setItem('oncoguia-theme', theme);
            });
        }
        
        function applyTheme(theme) {
            const body = document.body;
            body.className = body.className.replace(/\b(light|dark)\b/g, theme);
        }
        
        // Automatic calculations
        function calculateAutomaticValues() {
            const weight = parseFloat(document.getElementById('patientWeight').value) || 0;
            const height = parseFloat(document.getElementById('patientHeight').value) || 0;
            const age = parseInt(document.getElementById('patientAge').value) || 0;
            const gender = document.getElementById('patientGender').value;
            const creatinine = parseFloat(document.getElementById('patientCreatinine').value) || 0;
            
            // Body Surface Area (Mosteller formula)
            let bsa = 0;
            if (weight > 0 && height > 0) {
                bsa = Math.sqrt((weight * height) / 3600);
                document.getElementById('bsaValue').textContent = bsa.toFixed(2) + ' m¬≤';
            } else {
                document.getElementById('bsaValue').textContent = '-- m¬≤';
            }
            
            // BMI
            let bmi = 0;
            if (weight > 0 && height > 0) {
                bmi = weight / Math.pow(height / 100, 2);
                document.getElementById('bmiValue').textContent = bmi.toFixed(1) + ' kg/m¬≤';
            } else {
                document.getElementById('bmiValue').textContent = '-- kg/m¬≤';
            }
            
            // Creatinine Clearance (Cockcroft-Gault)
            let crcl = 0;
            if (age > 0 && weight > 0 && creatinine > 0 && gender) {
                const genderFactor = gender === 'F' ? 0.85 : 1.0;
                crcl = ((140 - age) * weight * genderFactor) / (72 * creatinine);
                document.getElementById('crclValue').textContent = crcl.toFixed(0) + ' mL/min';
            } else {
                document.getElementById('crclValue').textContent = '-- mL/min';
            }
        }
        
        // Document type handling
        function handleDocumentTypeChange() {
            const documentType = document.getElementById('documentType').value;
            const dynamicContent = document.getElementById('dynamicContent');
            
            dynamicContent.innerHTML = '';
            
            switch (documentType) {
                case 'chemotherapy':
                    dynamicContent.innerHTML = createChemotherapyForm();
                    break;
                case 'prescription':
                    dynamicContent.innerHTML = createPrescriptionForm();
                    break;
                case 'laboratory':
                    dynamicContent.innerHTML = createLaboratoryForm();
                    break;
                case 'imaging':
                    dynamicContent.innerHTML = createImagingForm();
                    break;
                case 'instructions':
                    dynamicContent.innerHTML = createInstructionsForm();
                    break;
                default:
                    dynamicContent.innerHTML = `
                        <div class="text-center py-8 theme-text-secondary">
                            <i class="fas fa-arrow-up text-4xl mb-4"></i>
                            <p>Seleccione un tipo de documento para continuar</p>
                        </div>
                    `;
            }
            
            updateGenerateButton();
        }
        
        function createChemotherapyForm() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Configuraci√≥n de Quimioterapia</h3>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Diagn√≥stico</label>
                        <input type="text" id="diagnosis" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: Ca mama T2N1M0 HER2+">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Tipo de Documento</label>
                        <select id="chemoDocType" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="patient_guide">Gu√≠a para Paciente</option>
                            <option value="medical_instructions">Indicaciones M√©dicas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Esquema de Tratamiento</label>
                        <select id="treatmentScheme" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="">Seleccionar esquema...</option>
                            <optgroup label="Mama">
                                <option value="ac">AC (Doxorrubicina + Ciclofosfamida)</option>
                                <option value="act">AC-T (AC ‚Üí Paclitaxel)</option>
                                <option value="tch">TCH (Docetaxel + Carboplatino + Trastuzumab)</option>
                                <option value="trastuzumab_iv">Trastuzumab IV</option>
                                <option value="trastuzumab_sc">Trastuzumab SC</option>
                                <option value="pertuzumab">Pertuzumab</option>
                                <option value="tdm1">T-DM1 (Kadcyla)</option>
                                <option value="tdxd">T-DXd (Enhertu)</option>
                                <option value="phesgo">Phesgo (Pertuzumab + Trastuzumab SC)</option>
                                <option value="paclitaxel">Paclitaxel semanal</option>
                                <option value="docetaxel">Docetaxel</option>
                            </optgroup>
                            <optgroup label="Colorrectal">
                                <option value="folfox">FOLFOX</option>
                                <option value="folfiri">FOLFIRI</option>
                                <option value="folfiri_cetuximab">FOLFIRI + Cetuximab</option>
                                <option value="folfiri_bevacizumab">FOLFIRI + Bevacizumab</option>
                                <option value="capox_bevacizumab">CAPOX + Bevacizumab</option>
                                <option value="gramont">Esquema Gramont</option>
                            </optgroup>
                            <optgroup label="P√°ncreas">
                                <option value="folfirinox">FOLFIRINOX</option>
                                <option value="gemcitabine_carboplatin">Gemcitabina + Carboplatino</option>
                            </optgroup>
                            <optgroup label="G√°strico">
                                <option value="flot">FLOT</option>
                            </optgroup>
                            <optgroup label="Testicular">
                                <option value="bep">BEP</option>
                                <option value="ep">EP</option>
                            </optgroup>
                            <optgroup label="Pulm√≥n/Ovario">
                                <option value="carboplatin_paclitaxel">Carboplatino + Paclitaxel</option>
                            </optgroup>
                            <optgroup label="Monodrogas">
                                <option value="cisplatin">Cisplatino</option>
                                <option value="carboplatin">Carboplatino</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">N√∫mero de Ciclos</label>
                        <input type="number" id="cycleNumber" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" min="1" max="12" value="4">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Notas Adicionales</label>
                        <textarea id="additionalNotes" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="3" placeholder="Notas espec√≠ficas del caso..."></textarea>
                    </div>
                </div>
            `;
        }
        
        function createPrescriptionForm() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Receta M√©dica</h3>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Medicamento</label>
                        <input type="text" id="medication" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: Ondansetr√≥n">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Concentraci√≥n</label>
                            <input type="text" id="concentration" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: 8 mg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium theme-text-primary mb-1">Presentaci√≥n</label>
                            <input type="text" id="presentation" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: Tabletas">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Dosis y Frecuencia</label>
                        <input type="text" id="dosage" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: 1 tableta cada 8 horas">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">V√≠a de Administraci√≥n</label>
                        <select id="route" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="oral">V√≠a Oral</option>
                            <option value="iv">Intravenosa</option>
                            <option value="im">Intramuscular</option>
                            <option value="sc">Subcut√°nea</option>
                            <option value="topical">T√≥pica</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Duraci√≥n</label>
                        <input type="text" id="duration" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" placeholder="Ej: 5 d√≠as">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Instrucciones Especiales</label>
                        <textarea id="instructions" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="3" placeholder="Instrucciones adicionales..."></textarea>
                    </div>
                </div>
            `;
        }
        
        function createLaboratoryForm() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Solicitud de Laboratorio</h3>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Panel de Estudios</label>
                        <select id="labPanel" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="">Seleccionar panel...</option>
                            <option value="basic">Panel B√°sico (BH, QS, PFH, PFR)</option>
                            <option value="pre_chemo">Pre-Quimioterapia (+ Tiempos de coagulaci√≥n)</option>
                            <option value="follow_up">Seguimiento (+ Marcadores tumorales)</option>
                            <option value="toxicity">Evaluaci√≥n Toxicidad (+ CPK, LDH, Mg)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Estudios Espec√≠ficos</label>
                        <textarea id="specificTests" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="3" placeholder="Estudios adicionales espec√≠ficos..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Urgencia</label>
                        <select id="urgency" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="routine">Rutina</option>
                            <option value="urgent">Urgente</option>
                            <option value="stat">STAT</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Indicaci√≥n Cl√≠nica</label>
                        <textarea id="clinicalIndication" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="2" placeholder="Indicaci√≥n o sospecha diagn√≥stica..."></textarea>
                    </div>
                </div>
            `;
        }
        
        function createImagingForm() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Solicitud de Imagen</h3>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Tipo de Estudio</label>
                        <select id="imagingType" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="">Seleccionar tipo...</option>
                            <option value="ct">Tomograf√≠a Computada (TC)</option>
                            <option value="mri">Resonancia Magn√©tica (RM)</option>
                            <option value="us">Ultrasonido</option>
                            <option value="xray">Radiograf√≠a</option>
                            <option value="pet">PET-CT</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Regi√≥n Anat√≥mica</label>
                        <select id="anatomicRegion" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="">Seleccionar regi√≥n...</option>
                            <option value="thorax">T√≥rax</option>
                            <option value="abdomen">Abdomen</option>
                            <option value="pelvis">Pelvis</option>
                            <option value="tap">T√≥rax, Abdomen y Pelvis</option>
                            <option value="brain">Cerebro</option>
                            <option value="neck">Cuello</option>
                            <option value="extremities">Extremidades</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Contraste</label>
                        <select id="contrast" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="none">Sin contraste</option>
                            <option value="iv">Contraste IV</option>
                            <option value="oral">Contraste oral</option>
                            <option value="both">Contraste IV y oral</option>
                        </select>
                    </div>
                    
                    <div id="contrastWarning" class="hidden p-3 bg-yellow-100 border border-yellow-400 rounded-lg">
                        <p class="text-yellow-800 text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Requiere creatinina ‚â§ 1.5 mg/dL</strong> - Verificar funci√≥n renal antes del estudio
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Indicaci√≥n Cl√≠nica</label>
                        <textarea id="imagingIndication" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="3" placeholder="Indicaci√≥n o sospecha diagn√≥stica..."></textarea>
                    </div>
                </div>
            `;
        }
        
        function createInstructionsForm() {
            return `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold theme-text-primary">Indicaciones M√©dicas</h3>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Tipo de Indicaciones</label>
                        <select id="instructionsType" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                            <option value="post_chemo">Post-Quimioterapia</option>
                            <option value="pre_surgery">Pre-Quir√∫rgicas</option>
                            <option value="discharge">Alta Hospitalaria</option>
                            <option value="follow_up">Seguimiento</option>
                            <option value="custom">Personalizadas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Indicaciones Espec√≠ficas</label>
                        <textarea id="specificInstructions" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="6" placeholder="Escriba las indicaciones espec√≠ficas..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Signos de Alarma</label>
                        <textarea id="alarmSigns" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary" rows="3" placeholder="Signos de alarma que requieren contacto inmediato..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium theme-text-primary mb-1">Pr√≥xima Cita</label>
                        <input type="date" id="nextAppointment" class="w-full px-3 py-2 border theme-border rounded-lg theme-bg-primary theme-text-primary">
                    </div>
                </div>
            `;
        }
        
        function updateGenerateButton() {
            const documentType = document.getElementById('documentType').value;
            const patientName = document.getElementById('patientName').value;
            const generateBtn = document.getElementById('generateBtn');
            
            if (documentType && patientName) {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Document generation
        function generateDocument() {
            const documentType = document.getElementById('documentType').value;
            
            switch (documentType) {
                case 'chemotherapy':
                    generateChemotherapyDocument();
                    break;
                case 'prescription':
                    generatePrescriptionDocument();
                    break;
                case 'laboratory':
                    generateLaboratoryDocument();
                    break;
                case 'imaging':
                    generateImagingDocument();
                    break;
                case 'instructions':
                    generateInstructionsDocument();
                    break;
            }
            
            // Enable export buttons
            document.getElementById('pdfBtn').disabled = false;
            document.getElementById('emailBtn').disabled = false;
            document.getElementById('jsonBtn').disabled = false;
        }
        
        function generateChemotherapyDocument() {
            const patientData = getPatientData();
            const diagnosis = document.getElementById('diagnosis').value;
            const docType = document.getElementById('chemoDocType').value;
            const scheme = document.getElementById('treatmentScheme').value;
            const cycles = document.getElementById('cycleNumber').value;
            const notes = document.getElementById('additionalNotes').value;
            
            const schemeData = getSchemeData(scheme);
            const doses = calculateDoses(schemeData, patientData);
            
            let content = `
                <div class="document-preview">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" style="height: 60px; margin-bottom: 10px;">
                        <h1 style="color: #dc2626; margin: 0;">OncoTech - Centro de Oncolog√≠a</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129-71-71</p>
                    </div>
                    
                    <h1>${docType === 'patient_guide' ? 'Gu√≠a de Quimioterapia para el Paciente' : 'Indicaciones M√©dicas de Quimioterapia'}</h1>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Datos del Paciente</h2>
                        <p><strong>Nombre:</strong> ${patientData.name}</p>
                        <p><strong>Edad:</strong> ${patientData.age} a√±os</p>
                        <p><strong>Sexo:</strong> ${patientData.gender === 'M' ? 'Masculino' : 'Femenino'}</p>
                        <p><strong>Peso:</strong> ${patientData.weight} kg</p>
                        <p><strong>Estatura:</strong> ${patientData.height} cm</p>
                        <p><strong>Superficie Corporal:</strong> ${patientData.bsa} m¬≤</p>
                        ${patientData.creatinine ? `<p><strong>Creatinina:</strong> ${patientData.creatinine} mg/dL</p>` : ''}
                        ${patientData.crcl ? `<p><strong>Depuraci√≥n de Creatinina:</strong> ${patientData.crcl} mL/min</p>` : ''}
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Informaci√≥n del Tratamiento</h2>
                        <p><strong>Diagn√≥stico:</strong> ${diagnosis}</p>
                        <p><strong>Esquema:</strong> ${schemeData.name}</p>
                        <p><strong>N√∫mero de Ciclos:</strong> ${cycles}</p>
                        <p><strong>Frecuencia:</strong> ${schemeData.frequency}</p>
                    </div>
            `;
            
            if (docType === 'medical_instructions') {
                content += generateMedicalInstructions(schemeData, doses);
            } else {
                content += generatePatientGuide(schemeData, doses);
            }
            
            if (notes) {
                content += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h3>Notas Adicionales</h3>
                        <p>${notes}</p>
                    </div>
                `;
            }
            
            content += `
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-MX')} con OncoGu√≠a Pro v8.0</p>
                        <p>OncoTech - Solo con previa cita ‚Ä¢ No urgencias</p>
                    </div>
                </div>
            `;
            
            document.getElementById('documentPreview').innerHTML = content;
            currentDocumentData = { type: 'chemotherapy', content: content, patient: patientData };
        }
        
        function generatePrescriptionDocument() {
            const patientData = getPatientData();
            const medication = document.getElementById('medication').value;
            const concentration = document.getElementById('concentration').value;
            const presentation = document.getElementById('presentation').value;
            const dosage = document.getElementById('dosage').value;
            const route = document.getElementById('route').value;
            const duration = document.getElementById('duration').value;
            const instructions = document.getElementById('instructions').value;
            
            const content = `
                <div class="document-preview">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" style="height: 60px; margin-bottom: 10px;">
                        <h1 style="color: #dc2626; margin: 0;">OncoTech - Centro de Oncolog√≠a</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129-71-71</p>
                    </div>
                    
                    <h1>RECETA M√âDICA</h1>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Paciente:</strong> ${patientData.name}</p>
                        <p><strong>Edad:</strong> ${patientData.age} a√±os</p>
                        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-MX')}</p>
                    </div>
                    
                    <div style="background: white; border: 2px solid #dc2626; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h2 style="color: #dc2626;">Rx:</h2>
                        <div style="font-size: 18px; line-height: 1.8;">
                            <p><strong>${medication} ${concentration}</strong></p>
                            <p><strong>Presentaci√≥n:</strong> ${presentation}</p>
                            <p><strong>Indicaciones:</strong> ${dosage}</p>
                            <p><strong>V√≠a:</strong> ${route}</p>
                            <p><strong>Duraci√≥n:</strong> ${duration}</p>
                            ${instructions ? `<p><strong>Instrucciones especiales:</strong> ${instructions}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: right;">
                        <div style="border-top: 1px solid #000; width: 300px; margin-left: auto; padding-top: 10px;">
                            <p><strong>Dr. [NOMBRE]</strong></p>
                            <p>C√©dula: [N√öMERO]</p>
                            <p>OncoTech - Centro de Oncolog√≠a</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-MX')} con OncoGu√≠a Pro v8.0</p>
                    </div>
                </div>
            `;
            
            document.getElementById('documentPreview').innerHTML = content;
            currentDocumentData = { type: 'prescription', content: content, patient: patientData };
        }
        
        function generateLaboratoryDocument() {
            const patientData = getPatientData();
            const panel = document.getElementById('labPanel').value;
            const specificTests = document.getElementById('specificTests').value;
            const urgency = document.getElementById('urgency').value;
            const indication = document.getElementById('clinicalIndication').value;
            
            const panelData = getLabPanelData(panel);
            const preparation = getLabPreparation(panel);
            
            const content = `
                <div class="document-preview">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" style="height: 60px; margin-bottom: 10px;">
                        <h1 style="color: #dc2626; margin: 0;">OncoTech - Centro de Oncolog√≠a</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129-71-71</p>
                    </div>
                    
                    <h1>SOLICITUD DE LABORATORIO</h1>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Paciente:</strong> ${patientData.name}</p>
                                <p><strong>Edad:</strong> ${patientData.age} a√±os</p>
                                <p><strong>Sexo:</strong> ${patientData.gender === 'M' ? 'Masculino' : 'Femenino'}</p>
                            </div>
                            <div>
                                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-MX')}</p>
                                <p><strong>Urgencia:</strong> ${urgency.charAt(0).toUpperCase() + urgency.slice(1)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Estudios Solicitados</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            ${panelData.tests.map(test => `<div style="padding: 8px; background: white; border-radius: 4px;">‚òê ${test}</div>`).join('')}
                        </div>
                        ${specificTests ? `
                            <h3 style="margin-top: 15px;">Estudios Adicionales:</h3>
                            <p>${specificTests}</p>
                        ` : ''}
                    </div>
                    
                    ${indication ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>Indicaci√≥n Cl√≠nica</h3>
                            <p>${indication}</p>
                        </div>
                    ` : ''}
                    
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>Preparaci√≥n del Paciente</h3>
                        <ul>
                            ${preparation.map(prep => `<li>${prep}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: right;">
                        <div style="border-top: 1px solid #000; width: 300px; margin-left: auto; padding-top: 10px;">
                            <p><strong>Dr. [NOMBRE]</strong></p>
                            <p>C√©dula: [N√öMERO]</p>
                            <p>OncoTech - Centro de Oncolog√≠a</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-MX')} con OncoGu√≠a Pro v8.0</p>
                    </div>
                </div>
            `;
            
            document.getElementById('documentPreview').innerHTML = content;
            currentDocumentData = { type: 'laboratory', content: content, patient: patientData };
        }
        
        function generateImagingDocument() {
            const patientData = getPatientData();
            const imagingType = document.getElementById('imagingType').value;
            const region = document.getElementById('anatomicRegion').value;
            const contrast = document.getElementById('contrast').value;
            const indication = document.getElementById('imagingIndication').value;
            
            const studyData = getImagingStudyData(imagingType, region, contrast);
            const preparation = getImagingPreparation(imagingType, contrast);
            
            const content = `
                <div class="document-preview">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" style="height: 60px; margin-bottom: 10px;">
                        <h1 style="color: #dc2626; margin: 0;">OncoTech - Centro de Oncolog√≠a</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129-71-71</p>
                    </div>
                    
                    <h1>SOLICITUD DE ESTUDIO DE IMAGEN</h1>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Paciente:</strong> ${patientData.name}</p>
                                <p><strong>Edad:</strong> ${patientData.age} a√±os</p>
                                <p><strong>Sexo:</strong> ${patientData.gender === 'M' ? 'Masculino' : 'Femenino'}</p>
                                ${patientData.creatinine ? `<p><strong>Creatinina:</strong> ${patientData.creatinine} mg/dL</p>` : ''}
                            </div>
                            <div>
                                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-MX')}</p>
                                <p><strong>Peso:</strong> ${patientData.weight} kg</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Estudio Solicitado</h2>
                        <div style="font-size: 18px; font-weight: bold; color: #dc2626; margin: 10px 0;">
                            ${studyData.fullName}
                        </div>
                        <p><strong>Modalidad:</strong> ${studyData.modality}</p>
                        <p><strong>Regi√≥n:</strong> ${studyData.region}</p>
                        <p><strong>Contraste:</strong> ${studyData.contrast}</p>
                    </div>
                    
                    ${(contrast === 'iv' || contrast === 'both') && patientData.creatinine > 1.5 ? `
                        <div style="background: #f8d7da; border: 2px solid #dc3545; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #dc3545;">‚ö†Ô∏è ALERTA DE CREATININA</h3>
                            <p>Creatinina elevada (${patientData.creatinine} mg/dL). Evaluar riesgo/beneficio del contraste o considerar pre-hidrataci√≥n.</p>
                        </div>
                    ` : ''}
                    
                    ${indication ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>Indicaci√≥n Cl√≠nica</h3>
                            <p>${indication}</p>
                        </div>
                    ` : ''}
                    
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>Preparaci√≥n del Paciente</h3>
                        <ul>
                            ${preparation.map(prep => `<li>${prep}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: right;">
                        <div style="border-top: 1px solid #000; width: 300px; margin-left: auto; padding-top: 10px;">
                            <p><strong>Dr. [NOMBRE]</strong></p>
                            <p>C√©dula: [N√öMERO]</p>
                            <p>OncoTech - Centro de Oncolog√≠a</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-MX')} con OncoGu√≠a Pro v8.0</p>
                    </div>
                </div>
            `;
            
            document.getElementById('documentPreview').innerHTML = content;
            currentDocumentData = { type: 'imaging', content: content, patient: patientData };
        }
        
        function generateInstructionsDocument() {
            const patientData = getPatientData();
            const instructionsType = document.getElementById('instructionsType').value;
            const specificInstructions = document.getElementById('specificInstructions').value;
            const alarmSigns = document.getElementById('alarmSigns').value;
            const nextAppointment = document.getElementById('nextAppointment').value;
            
            const content = `
                <div class="document-preview">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #dc2626; padding-bottom: 20px;">
                        <img src="https://www.jotform.com/uploads/jeanp27/form_files/Logo%20para%20membrete.684c557f007857.92019324.png" alt="OncoTech" style="height: 60px; margin-bottom: 10px;">
                        <h1 style="color: #dc2626; margin: 0;">OncoTech - Centro de Oncolog√≠a</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Normal Urbana 1367, Colonia Perla, La Paz, BCS | Tel: (612) 129-71-71</p>
                    </div>
                    
                    <h1>INDICACIONES M√âDICAS</h1>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Paciente:</strong> ${patientData.name}</p>
                        <p><strong>Edad:</strong> ${patientData.age} a√±os</p>
                        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-MX')}</p>
                        <p><strong>Tipo de indicaciones:</strong> ${getInstructionsTypeName(instructionsType)}</p>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>Indicaciones Espec√≠ficas</h2>
                        <div style="white-space: pre-line; line-height: 1.6;">
                            ${specificInstructions}
                        </div>
                    </div>
                    
                    ${alarmSigns ? `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #dc3545;">üö® Signos de Alarma</h3>
                            <p>Contacte inmediatamente a OncoTech al (612) 129-71-71 si presenta:</p>
                            <div style="white-space: pre-line; line-height: 1.6;">
                                ${alarmSigns}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${nextAppointment ? `
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3>üìÖ Pr√≥xima Cita</h3>
                            <p><strong>Fecha:</strong> ${new Date(nextAppointment).toLocaleDateString('es-MX')}</p>
                            <p>Recuerde acudir puntualmente. Solo se atiende con previa cita.</p>
                        </div>
                    ` : ''}
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>Contacto</h3>
                        <p><strong>OncoTech - Centro de Oncolog√≠a</strong></p>
                        <p>üìç Normal Urbana 1367, Colonia Perla, La Paz, BCS</p>
                        <p>üìû (612) 129-71-71</p>
                        <p>üïò Lunes a Viernes: 9:00 AM - 9:00 PM</p>
                        <p>‚ö†Ô∏è Solo con previa cita ‚Ä¢ No se atienden urgencias</p>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: right;">
                        <div style="border-top: 1px solid #000; width: 300px; margin-left: auto; padding-top: 10px;">
                            <p><strong>Dr. [NOMBRE]</strong></p>
                            <p>C√©dula: [N√öMERO]</p>
                            <p>OncoTech - Centro de Oncolog√≠a</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>Documento generado el ${new Date().toLocaleDateString('es-MX')} con OncoGu√≠a Pro v8.0</p>
                    </div>
                </div>
            `;
            
            document.getElementById('documentPreview').innerHTML = content;
            currentDocumentData = { type: 'instructions', content: content, patient: patientData };
        }
        
        // Helper functions
        function getPatientData() {
            const weight = parseFloat(document.getElementById('patientWeight').value) || 0;
            const height = parseFloat(document.getElementById('patientHeight').value) || 0;
            const age = parseInt(document.getElementById('patientAge').value) || 0;
            const gender = document.getElementById('patientGender').value;
            const creatinine = parseFloat(document.getElementById('patientCreatinine').value) || 0;
            
            let bsa = 0;
            if (weight > 0 && height > 0) {
                bsa = Math.sqrt((weight * height) / 3600);
            }
            
            let crcl = 0;
            if (age > 0 && weight > 0 && creatinine > 0 && gender) {
                const genderFactor = gender === 'F' ? 0.85 : 1.0;
                crcl = ((140 - age) * weight * genderFactor) / (72 * creatinine);
            }
            
            return {
                name: document.getElementById('patientName').value,
                age: age,
                gender: gender,
                weight: weight,
                height: height,
                creatinine: creatinine,
                bsa: bsa.toFixed(2),
                crcl: crcl ? crcl.toFixed(0) : null
            };
        }
        
        function getSchemeData(scheme) {
            const schemes = {
                'ac': {
                    name: 'AC (Doxorrubicina + Ciclofosfamida)',
                    frequency: 'Cada 21 d√≠as',
                    drugs: [
                        { name: 'Doxorrubicina', dose: '60 mg/m¬≤', route: 'IV', time: '15 min', day: '1' },
                        { name: 'Ciclofosfamida', dose: '600 mg/m¬≤', route: 'IV', time: '30 min', day: '1' }
                    ]
                },
                'folfox': {
                    name: 'FOLFOX',
                    frequency: 'Cada 14 d√≠as',
                    drugs: [
                        { name: 'Oxaliplatino', dose: '85 mg/m¬≤', route: 'IV', time: '2 h', day: '1' },
                        { name: 'Leucovorina', dose: '400 mg/m¬≤', route: 'IV', time: '2 h', day: '1' },
                        { name: '5-FU bolo', dose: '400 mg/m¬≤', route: 'IV', time: 'bolo', day: '1' },
                        { name: '5-FU infusi√≥n', dose: '2400 mg/m¬≤', route: 'IV', time: '46 h', day: '1-2' }
                    ]
                },
                'trastuzumab_iv': {
                    name: 'Trastuzumab IV',
                    frequency: 'Cada 21 d√≠as',
                    drugs: [
                        { name: 'Trastuzumab', dose: '8 mg/kg (carga), 6 mg/kg (mant)', route: 'IV', time: '90 min (carga), 30 min (mant)', day: '1' }
                    ]
                },
                'phesgo': {
                    name: 'Phesgo (Pertuzumab + Trastuzumab SC)',
                    frequency: 'Cada 21 d√≠as',
                    drugs: [
                        { name: 'Phesgo', dose: '1200/600 mg (carga), 600/600 mg (mant)', route: 'SC', time: '5-8 min', day: '1' }
                    ]
                }
            };
            
            return schemes[scheme] || { name: 'Esquema personalizado', frequency: 'Seg√∫n protocolo', drugs: [] };
        }
        
        function calculateDoses(schemeData, patientData) {
            return schemeData.drugs.map(drug => {
                let calculatedDose = drug.dose;
                if (drug.dose.includes('mg/m¬≤')) {
                    const dosePerM2 = parseFloat(drug.dose.match(/[\d.]+/)[0]);
                    const totalDose = (dosePerM2 * parseFloat(patientData.bsa)).toFixed(1);
                    calculatedDose = `${totalDose} mg`;
                }
                return { ...drug, calculatedDose };
            });
        }
        
        function generateMedicalInstructions(schemeData, doses) {
            return `
                <h2>Indicaciones M√©dicas</h2>
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Premedicaci√≥n</h3>
                    <ul>
                        <li>Ondansetr√≥n 8 mg IV 30 min antes</li>
                        <li>Dexametasona 12 mg IV 30 min antes</li>
                        <li>Ranitidina 50 mg IV 30 min antes</li>
                    </ul>
                </div>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Medicamentos y Dosis</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #dc2626; color: white;">
                                <th style="padding: 10px; text-align: left;">Medicamento</th>
                                <th style="padding: 10px; text-align: left;">Dosis</th>
                                <th style="padding: 10px; text-align: left;">V√≠a</th>
                                <th style="padding: 10px; text-align: left;">Tiempo</th>
                                <th style="padding: 10px; text-align: left;">D√≠a</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${doses.map(drug => `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 10px;">${drug.name}</td>
                                    <td style="padding: 10px;">${drug.calculatedDose || drug.dose}</td>
                                    <td style="padding: 10px;">${drug.route}</td>
                                    <td style="padding: 10px;">${drug.time}</td>
                                    <td style="padding: 10px;">${drug.day}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Monitoreo</h3>
                    <ul>
                        <li>Signos vitales cada 30 min durante infusi√≥n</li>
                        <li>Vigilar reacciones de hipersensibilidad</li>
                        <li>BH y QS previo a cada ciclo</li>
                    </ul>
                </div>
            `;
        }
        
        function generatePatientGuide(schemeData, doses) {
            return `
                <h2>Informaci√≥n para el Paciente</h2>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>¬øQu√© es la Quimioterapia?</h3>
                    <p>La quimioterapia son medicamentos que ayudan a combatir las c√©lulas cancerosas. El esquema ${schemeData.name} se administra ${schemeData.frequency}.</p>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Efectos Secundarios Comunes</h3>
                    <ul>
                        <li><strong>N√°usea y v√≥mito:</strong> Tome los medicamentos prescritos seg√∫n indicaci√≥n</li>
                        <li><strong>Cansancio:</strong> Es normal, descanse cuando lo necesite</li>
                        <li><strong>Ca√≠da del cabello:</strong> Temporal, crecer√° nuevamente</li>
                        <li><strong>Cambios en el apetito:</strong> Coma porciones peque√±as y frecuentes</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Cuidados en Casa</h3>
                    <ul>
                        <li>L√°vese las manos frecuentemente</li>
                        <li>Evite lugares con muchas personas</li>
                        <li>Tome mucha agua (2-3 litros al d√≠a)</li>
                        <li>Use protector solar</li>
                        <li>Mantenga una buena higiene bucal</li>
                    </ul>
                </div>
                
                <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>‚ö†Ô∏è Cu√°ndo Contactar al M√©dico</h3>
                    <p><strong>Llame inmediatamente al (612) 129-71-71 si presenta:</strong></p>
                    <ul>
                        <li>Fiebre mayor a 38¬∞C</li>
                        <li>Sangrado anormal</li>
                        <li>Dificultad para respirar</li>
                        <li>V√≥mito que no para</li>
                        <li>Diarrea severa</li>
                    </ul>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Timing de Laboratorios</h3>
                    <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <p><strong>‚ö†Ô∏è IMPORTANTE:</strong></p>
                        <p><strong>Cu√°ndo S√ç hacerse laboratorios:</strong></p>
                        <ul>
                            <li>1-3 d√≠as antes del siguiente ciclo</li>
                            <li>Cuando el m√©dico lo solicite espec√≠ficamente</li>
                        </ul>
                        <p><strong>Cu√°ndo NO hacerse laboratorios:</strong></p>
                        <ul>
                            <li>Entre los d√≠as 5-14 despu√©s de la quimio</li>
                            <li>Por curiosidad o ansiedad</li>
                        </ul>
                        <p><em>Los valores bajos entre ciclos son normales y esperados.</em></p>
                    </div>
                </div>
            `;
        }
        
        function getLabPanelData(panel) {
            const panels = {
                'basic': {
                    name: 'Panel B√°sico',
                    tests: ['Biometr√≠a Hem√°tica Completa', 'Qu√≠mica Sangu√≠nea', 'Pruebas de Funci√≥n Hep√°tica', 'Pruebas de Funci√≥n Renal']
                },
                'pre_chemo': {
                    name: 'Pre-Quimioterapia',
                    tests: ['Biometr√≠a Hem√°tica Completa', 'Qu√≠mica Sangu√≠nea', 'Pruebas de Funci√≥n Hep√°tica', 'Pruebas de Funci√≥n Renal', 'Tiempo de Protrombina', 'Tiempo de Tromboplastina']
                },
                'follow_up': {
                    name: 'Seguimiento',
                    tests: ['Biometr√≠a Hem√°tica Completa', 'Qu√≠mica Sangu√≠nea', 'Pruebas de Funci√≥n Hep√°tica', 'CEA', 'CA 19-9', 'CA 15-3']
                },
                'toxicity': {
                    name: 'Evaluaci√≥n Toxicidad',
                    tests: ['Biometr√≠a Hem√°tica Completa', 'Qu√≠mica Sangu√≠nea', 'CPK', 'LDH', 'Magnesio', 'Fosfatasa Alcalina']
                }
            };
            
            return panels[panel] || { name: 'Panel Personalizado', tests: [] };
        }
        
        function getLabPreparation(panel) {
            return [
                'Ayuno de 8-12 horas (solo agua simple)',
                'Suspender multivitam√≠nicos 24 horas antes',
                'Informar medicamentos actuales',
                'Traer identificaci√≥n oficial',
                'Acudir con acompa√±ante si es posible'
            ];
        }
        
        function getImagingStudyData(type, region, contrast) {
            const studies = {
                'ct': { modality: 'Tomograf√≠a Computada', abbrev: 'TC' },
                'mri': { modality: 'Resonancia Magn√©tica', abbrev: 'RM' },
                'us': { modality: 'Ultrasonido', abbrev: 'US' },
                'xray': { modality: 'Radiograf√≠a', abbrev: 'RX' },
                'pet': { modality: 'PET-CT', abbrev: 'PET-CT' }
            };
            
            const regions = {
                'thorax': 'T√≥rax',
                'abdomen': 'Abdomen',
                'pelvis': 'Pelvis',
                'tap': 'T√≥rax, Abdomen y Pelvis',
                'brain': 'Cerebro',
                'neck': 'Cuello',
                'extremities': 'Extremidades'
            };
            
            const contrasts = {
                'none': 'Simple (sin contraste)',
                'iv': 'Con contraste intravenoso',
                'oral': 'Con contraste oral',
                'both': 'Con contraste IV y oral'
            };
            
            const study = studies[type] || { modality: 'Estudio', abbrev: 'EST' };
            const regionName = regions[region] || 'Regi√≥n no especificada';
            const contrastName = contrasts[contrast] || 'Contraste no especificado';
            
            return {
                modality: study.modality,
                region: regionName,
                contrast: contrastName,
                fullName: `${study.abbrev} ${regionName} ${contrastName}`
            };
        }
        
        function getImagingPreparation(type, contrast) {
            let preparation = [];
            
            if (type === 'ct' || type === 'pet') {
                preparation.push('Ayuno de 4-6 horas antes del estudio');
            }
            
            if (contrast === 'iv' || contrast === 'both') {
                preparation.push('Creatinina s√©rica ‚â§ 1.5 mg/dL (m√°ximo 7 d√≠as)');
                preparation.push('Hidrataci√≥n abundante post-estudio');
                preparation.push('Suspender metformina 48 horas previas');
                preparation.push('Informar alergias previas a contrastes');
            }
            
            if (contrast === 'oral' || contrast === 'both') {
                preparation.push('Tomar contraste oral seg√∫n indicaciones');
            }
            
            if (type === 'mri') {
                preparation.push('Remover todos los objetos met√°licos');
                preparation.push('Informar marcapasos o implantes met√°licos');
                preparation.push('Informar claustrofobia');
            }
            
            if (type === 'pet') {
                preparation.push('Glucosa en ayunas < 150 mg/dL');
                preparation.push('Evitar ejercicio 24 horas previas');
                preparation.push('Suspender medicamentos para diabetes (consultar)');
            }
            
            preparation.push('Traer identificaci√≥n oficial');
            preparation.push('Llegar 30 minutos antes de la cita');
            
            return preparation;
        }
        
        function getInstructionsTypeName(type) {
            const types = {
                'post_chemo': 'Post-Quimioterapia',
                'pre_surgery': 'Pre-Quir√∫rgicas',
                'discharge': 'Alta Hospitalaria',
                'follow_up': 'Seguimiento',
                'custom': 'Personalizadas'
            };
            
            return types[type] || 'Indicaciones Generales';
        }
        
        // Export functions
        function exportToPDF() {
            if (!currentDocumentData.content) {
                alert('Primero debe generar un documento');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Simple text-based PDF export
            const lines = currentDocumentData.content
                .replace(/<[^>]*>/g, '\n')
                .split('\n')
                .filter(line => line.trim() !== '');
            
            let y = 20;
            lines.forEach(line => {
                if (y > 280) {
                    pdf.addPage();
                    y = 20;
                }
                pdf.text(line.substring(0, 80), 10, y);
                y += 7;
            });
            
            const fileName = `${currentDocumentData.patient.name.replace(/\s+/g, '_')}_${currentDocumentData.type}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);
        }
        
        function exportToJSON() {
            if (!currentDocumentData) {
                alert('Primero debe generar un documento');
                return;
            }
            
            const jsonData = {
                patient: currentDocumentData.patient,
                documentType: currentDocumentData.type,
                generatedDate: new Date().toISOString(),
                content: currentDocumentData.content
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentDocumentData.patient.name.replace(/\s+/g, '_')}_${currentDocumentData.type}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function sendEmail() {
            if (!currentDocumentData.content) {
                alert('Primero debe generar un documento');
                return;
            }
            
            const subject = `Documento M√©dico - ${currentDocumentData.patient.name}`;
            const body = `Estimado paciente,\n\nAdjunto encontrar√° su documento m√©dico generado en OncoTech.\n\nSaludos cordiales,\nOncoTech - Centro de Oncolog√≠a`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            // Load URL parameters
            loadURLParameters();
            
            // Patient data change listeners
            ['patientName', 'patientAge', 'patientGender', 'patientWeight', 'patientHeight', 'patientCreatinine'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    calculateAutomaticValues();
                    updateGenerateButton();
                });
            });
            
            // Document type change listener
            document.getElementById('documentType').addEventListener('change', handleDocumentTypeChange);
            
            // Button listeners
            document.getElementById('generateBtn').addEventListener('click', generateDocument);
            document.getElementById('pdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('emailBtn').addEventListener('click', sendEmail);
            document.getElementById('jsonBtn').addEventListener('click', exportToJSON);
            
            // Dynamic content listeners
            document.addEventListener('change', function(e) {
                if (e.target.id === 'contrast') {
                    const warning = document.getElementById('contrastWarning');
                    if (warning) {
                        const needsContrast = e.target.value === 'iv' || e.target.value === 'both';
                        warning.classList.toggle('hidden', !needsContrast);
                    }
                }
            });
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDlOnHXGa0LcFVQXRUSYhejdhJsq6R42MJpEGEjtrvWpYQYLwcoUrKAPchONSRvbSiE7aI%2FH1PrME84SMuL%2FXjUmv75o6iA5DUMcbDNw0XdoAWexBjRGuOH0eZY9KX5qSfDZtrcxHWSpF%2FhMfTUSROwl0NnDnFhotVf1wSxh%2F7uQBqHz3hXk6f5CgdBKVIS4ORTQUPGW8NOneQXMV1eS7BhTODDjusx%2FJoiixFlHxR%2FWdV7LzC3BTGabj%2BIvpBGe%2BZuz2hr57I7xgtFjxkqbomexKA57k6Yx3%2Bdodu9hwr7oAQNWq20zRx3XT3PhQ5NoSwNKft%2FJL9jhbar9JlK3nji%2BSuzE6Z0Z0u0n9kpkScgvCS%2B76z%2FeUIJY8Eu7pQnKgzoPuXhj%2FHu7HvY1fHUgH5OipR8kKmvPCIeDwkvhYbM0oaheTfDqnk3hCFHJ0wfB6t0vCJVJWZVtQuLR1G3GFgHN5dOFDdHvNVrtTZQoQOKbzt%2BqUsYY%2BVtzOUt%2BVwAyP6tdbw4X76K9dGmGpnht3TNc%3D";
        window.__genspark_locale = "es-ES";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDlOnHXGa0LcFVQXRUSYhejdhJsq6R42MJpEGEjtrvWpYQYLwcoUrKAPchONSRvbSiE7aI/H1PrME84SMuL/XjUmv75o6iA5DUMcbDNw0XdoAWexBjRGuOH0eZY9KX5qSfDZtrcxHWSpF/hMfTUSROwl0NnDnFhotVf1wSxh/7uQBqHz3hXk6f5CgdBKVIS4ORTQUPGW8NOneQXMV1eS7BhTODDjusx/JoiixFlHxR/WdV7LzC3BTGabj+IvpBGe+Zuz2hr57I7xgtFjxkqbomexKA57k6Yx3+dodu9hwr7oAQNWq20zRx3XT3PhQ5NoSwNKft/JL9jhbar9JlK3nji+SuzE6Z0Z0u0n9kpkScgvCS+76z/eUIJY8Eu7pQnKgzoPuXhj/Hu7HvY1fHUgH5OipR8kKmvPCIeDwkvhYbM0oaheTfDqnk3hCFHJ0wfB6t0vCJVJWZVtQuLR1G3GFgHN5dOFDdHvNVrtTZQoQOKbzt+qUsYY+VtzOUt+VwAyP6tdbw4X76K9dGmGpnht3TNc=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
